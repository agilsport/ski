<?xml version="1.0" encoding="UTF-8"?>

<edition>
	<menu>
		<menu title="Edition Participants" image="./res/32x32_juges.png" bold="false" cond ="($(Epreuve.Code_discipline)='RELAIS')">
			<menu title="Equipe Alpha (1-a) Officiels" image="./res/16x16_official.png" id="Lst_Relais" Officiel="1" first_header="1" orderby="Nom" DossardRelais="Lettre"/>
			<menu title="Equipe Alpha (1-a)" image="./res/16x16_official.png" id="Lst_Relais" Officiel="0" first_header="0" orderby="Nom" DossardRelais="Lettre"/>
			<menu title="Equipe Alpha (1/²)" image="./res/16x16_official.png" id="Lst_Relais" Officiel="0" first_header="0" orderby="Nom" DossardRelais="Numeric"/>
		</menu>
		<menu title="Edition Liste de Départ" image="./res/32x32_bib.png" bold="false" cond ="($(Epreuve.Code_discipline)='RELAIS')">
			<menu title="Relais (1-a) Officiels" image="./res/16x16_official.png"  Officiel="1" first_header="1" id="Lst_Relais" orderby="Dossard" DossardRelais="Lettre"/>
			<menu title="Relais (1-a)" image="./res/16x16_official.png"  Officiel="0" first_header="0" id="Lst_Relais" orderby="Dossard" DossardRelais="Lettre"/>
			<menu title="Relais (1/²)" image="./res/16x16_official.png" id="Lst_Relais" orderby="Dossard" DossardRelais="Numeric"/>
		</menu>
		<menu title="Résultats Relais" image="./res/32x32_ranking.png" bold="false" cond ="($(Epreuve.Code_discipline)='RELAIS')">
			<menu title="Officiels(1-a)" image="./res/16x16_official.png" id="res_Relais" Officiel="1" first_header="1" DossardRelais="Lettre" mode_lap="1" />
			<menu title="Officieux (1-a)" image="./res/16x16_official.png" id="res_Relais" Officiel="0" first_header="0" DossardRelais="Lettre" mode_lap="1" />
			<menu title="Relais (1/²)" image="./res/16x16_official.png" id="res_Relais" DossardRelais="Numeric" mode_lap="1" />
		</menu>
		<menu title="Résultats Patrouille" image="./res/32x32_ranking.png" bold="false" cond ="($(Epreuve.Code_discipline)='RELAIS')">
			<menu title="Officiels Patrouille (1-a)" image="./res/16x16_official.png" id="res_Patr" Officiel="1" first_header="1" DossardRelais="Lettre" />	
			<menu title="Officieux Patrouille (1-a)" image="./res/16x16_official.png" id="res_Patr" Officiel="0" first_header="0" DossardRelais="Lettre" />
			<menu title="Officiels Patrouille (1/²)" image="./res/16x16_official.png" id="res_Patr" Officiel="1" first_header="1" DossardRelais="Numeric" />
			<menu title="Patrouille (1/²)" image="./res/16x16_official.png" id="res_Patr" Officiel="0" first_header="0" DossardRelais="Numeric" />
			<menu title="Résultats Tours (1-a)" image="./res/16x16_official.png" id="res_Patr" DossardRelais="Lettre" />
		</menu>	
		<menu title="Résultats " image="./res/32x32_snow_esf.png">
			<menu title="Résultats Relais - Equipier Paysage" image="./res/16x16_juges.png" id="res_relais_equipier" choix_manche="1" mode_lap="1" first_header="0" />
			<menu title="Edition des Qualifiés Team-Sprint" image="./res/16x16_bib.png" id="res_qualif_TeamSprint" qualif_critere="1" />
			<menu title="Edition Finales Team-Sprint" image="./res/16x16_bib.png" id="res_TeamSprint" />
			
			<!-- <menu title="Tours (1-a)" image="./res/16x16_official.png" id="res_Tour" DossardRelais="Lettre" /> -->
		</menu>
	</menu>
	
	<!-- header standard !-->
	<header>
		<spacing all="0"/>
		<background mode="transparent"/>
		<font name="Calibri" size="14" adjust="max" weight="bold"/>
		<lua>
			entite = $(Evenement.Code_entite)
			discipline = $(Epreuve.Code_discipline)
			type_edition = id:sub(1,4)
			officiel = tonumber(params.officiel)
			Regroupement = $(Epreuve.Code_regroupement)
			if type_edition == 'Lst_' then
				Titre = 'Liste de départ \n '..params.title
			elseif type_edition == 'part' then
				Titre = 'Liste de Participants \n '..params.title
			elseif type_edition == 'res_' then
				Titre = 'Résultats \n '..params.title
			else
				Titre = title
			end
			flagQrCode = 0;
			if params ~= nil and params.Qrcode ~= nil then flagQrCode = params.Qrcode end
		</lua>	
		<text row="auto" col="1" align="center">$(Evenement.Nom)</text>
		<text row="auto" align="center">$(Discipline.Libelle)</text>
		<text row="auto" align="center" cond="params.code_epreuve ~= -1">$(Categorie{$(Epreuve.Code_categorie)}.Libelle)..' - '..$(Sexe{$(Epreuve.Sexe)}.Libelle)</text>
		<text row="auto" align="center" >Titre</text>
		<row h="0.5cm"/>
		<matrix row_start="-3" row_end="0" col_start="10" col_end="0">
			<row h="1.5cm" />
			<col w="1, 1.5cm" />
			<qrcode adjust="best" col_start="2" cond="tonumber(params.Qrcode)==1 and entite=='FFS' ">'https://live.ffs.fr/live_timing/live_cc.php?codex='..$(Epreuve.Fichier_transfert)</qrcode>
			<qrcode adjust="best" col_start="2" cond="tonumber(params.Qrcode)==1 and entite=='FIS' and $(Evenement.Commentaire_live):len() &gt; 0">'live.fis-ski.com/lv-al'..string.sub($(Epreuve.Fichier_transfert),4)..'.htm#/short'</qrcode>
		</matrix>
		<!-- affichage de la ligne d'heure de départ en massstart ou fond pop si pas de first header -->
		<lua>if type_edition == 'lst_' and first_header == '0' and discipline:In('MASS', 'POURS', 'POURS-D', 'FP') and $(Epreuve.Heure_depart):len() &gt; 0 then</lua>
		<call option="Ligne_H_depart" cond="editor:GetPageCurrent() == 1" file="./edition/options.xml"/>
		<lua>end</lua>
		<!-- affichage du Compteur des classés si c'est un resultat (id commence par 'res_' et si le first header n'est pas actif) -->
		<lua>if type_edition == 'res_' and first_header == '0' then</lua>
			<call option="stat_ranking" cond="editor:GetPageCurrent() == 1" file="./edition/options.xml"/>
		<lua>else </lua>
		<row value="0.4cm" />
		<lua>end </lua>
	</header>
		
	<!-- first_header standard !-->
	<first_header >
		<background mode="transparent"/>
		<font name="Calibri" size="9" adjust="best" weight="normal"/>
		<pen border="none" />
		<call option="identiteOfficiel" file="./edition/options.xml"/>
		<lua>type_edition = id:sub(1,4)</lua>
		<lua>entite = $(Evenement.Code_entite)</lua>
		<lua>discipline = $(Epreuve.Code_discipline)</lua>
		<col w="6,5,1, 0.2cm,4,4,1, 0.2cm,4,4,1" />

		<row h="auto" />
		<text col_start="1" col_end="3" align="center" underlined="1" font_size_step="1" font_weight="bold">'JURY DE COMPETITION'</text>
		<text col_start="5" col_end="7" align="center" underlined="1" font_size_step="1" font_weight="bold">'CARACTERISTIQUES DE LA PISTE'</text>
		<text col_start="9" col_end="11" align="center" underlined="1" font_size_step="1" font_weight="bold">'RENSEIGNEMENTS'</text>
		<row h="0.1cm" />

		<row h="auto" />
		<text col_start="1" align="left">'DELEGUE TECHNIQUE '..entite..':'</text>
		<text col_start="2" col_end="3" align="left">GetIdentiteOfficiels('TechnicalDelegate')</text>
		<text col_start="5" align="left" >'Nom du Site :'</text>
		<text col_start="6" align="left" >$(Pistes.Nom_piste)</text>
		<text col_start="9" align="left">'Lieu :'</text>
		<text col_start="10" col_end="0" align="right" >$(Epreuve_Nordique.Lieu)</text>
	
		<row h="auto" />
		<text col_start="1" align="left">'DT Adjoint :'</text>
		<text col_start="2" col_end="3" align="left">GetIdentiteOfficiels('TECHNICALDELEGATEASSISTANT')</text>
		<text col_start="5" align="left" >'Point Haut :'</text>
		<text col_start="6" align="left" >$(Epreuve.Point_haut)</text>
		<text col_start="9" align="left">'Categorie :'</text>
		<text col_start="10" col_end="0" align="right" >$(Categorie{$(Epreuve.Code_categorie)}.Libelle)</text>

		<row h="auto" />
		<text col_start="1" align="left">'DIRECTEUR D\'EPREUVE :'</text>
		<text col_start="2" col_end="3" align="left">GetIdentiteOfficiels('RACEDIRECTOR')</text>
		<text col_start="5" align="left" >'Point Bas :'</text>
		<text col_start="6" align="left" >$(Epreuve.Point_bas)</text>
		<text col_start="9" align="left">'Sexe :'</text>
		<text col_start="10" col_end="0" align="right" >$(Sexe{$(Epreuve.Sexe)}.Libelle)</text>
		
		<row h="auto" />
		<text col_start="1" align="left">'CHEF DE PISTE :'</text>
		<text col_start="2" col_end="3" align="left">GetIdentiteOfficiels('ChiefCompetition')</text>
		<text col_start="5" align="left" >'Montée maxi. :'</text>
		<text col_start="6" align="left" >$(Epreuve.Montee_maxi)</text>
		<text col_start="9" align="left">'Distance épreuve :'</text>
		<text col_start="10" col_end="0" align="right" >$(Epreuve.Distance):Suffix(' Km')</text>
		
		<row h="auto" />
		<text col_start="1" align="left">'COORDONNATEUR- '..entite..':'</text>
		<text col_start="2" align="left">GetIdentiteOfficiels('COORDINATOR')</text>
		<text col_start="5" align="left" >'Montée Totale. :'</text>
		<text col_start="6" align="left" >$(Epreuve.Montee_tot)</text>
		<text col_start="9" align="left">'Style :'</text>
		<lua>
			if $(Epreuve.Style) == 'L' then Style = 'Libre' 
			elseif $(Epreuve.Style) == 'C' then Style = 'Classique' 
			elseif $(Epreuve.Style) == 'C+L' then Style = 'Classique + Libre' 
			elseif $(Epreuve.Style) == 'L+C' then Style = 'Libre + Classique' end 
		</lua>
		<text col_start="10" col_end="0" align="right" >Style</text>
		
		<!-- mise en place de ligne verticale -->
		<line col_start="4" row_start="-5" row_end="0" pen_color="dkgray" border="mid_vert" />
		<line col_start="8" row_start="-5" row_end="0" pen_color="dkgray" border="mid_vert" />
		
		<row h="auto" />
		<lua>
			tClub = base:GetTable('Club')
			base:TableLoad(tClub, "Select * From Club Where Nom_reduit = '"..$(Evenement.Club):EscapeQuote().."'")
		</lua>
		<text col_start="1" col_end="4" align="left">'Club organisateur : '..$(Club.Nom_complet)</text>
		<text col_start="6" col_end="10" align="left" >'Organisateur : '..$(Evenement.Organisateur) </text>
		<!-- retour a la ligne de 0.1cm		 -->
		<row h="0.2cm" />
		<row value="auto" />
		<line col_start="1" col_end="0" pen_color="dkgray" border="top" />
		<row h="auto" />
		<text col_start="1" align="left">'Météo : '..$(Epreuve_Nordique.Meteo)</text>
		<text col_start="2" align="left">'Liste : '..$(Evenement.Code_liste)</text>
		<text col_start="5" col_end="6" align="left" >'Codex Epreuve : '..$(Epreuve.Fichier_transfert) </text>
		<text col_start="8" col_end="9" align="left" >'Coéficient F : '..$(Discipline.Facteur_f)</text>
		<text col_start="10" align="left" cond="params.title=='Officiels'" >'Penalité : '..$(Epreuve.Penalite_appliquee)</text>

		<!-- affichage de la ligne d'heure de départ en massstart ou fond pop -->
		<lua>if type_edition == 'lst_' and discipline:In('MASS','POURS-D', 'FP') and $(Epreuve.Heure_depart):len() &gt; 0 then</lua>
		<call option="Ligne_H_depart" cond="editor:GetPageCurrent() == 1 and $(Epreuve.Heure_depart) ~= nil" file="./edition/options.xml"/>
		<!-- affichage du Compteur des classés si c'est un resultat -->
		<lua>elseif type_edition == 'res_' then</lua>
			<call option="stat_ranking" cond="editor:GetPageCurrent() == 1" file="./edition/options.xml"/>
		<lua>else </lua>
		<row value="0.4cm" />
		<lua>end </lua>

	</first_header>
	
	<!-- footer standard !-->
	<footer>
		<background mode="transparent"/>
		<font name="Calibri" size="8" adjust="best" weight="normal"/>
		<pen border="none" />

		<lua>entite = entite or $(Evenement.Code_entite)</lua>
		<lua>info = $(Epreuve.Date_epreuve,'%2D/%2M/%4Y')..' / '..$(Evenement.Station)..' ('</lua>
		<lua cond="entite=='FIS'">info = info..$(Evenement.Code_nation)..'-'</lua>
		<lua>info = info..$(Evenement.Code_comite).. ') / '..$(Evenement.Organisateur)</lua>
		<text row="auto" col="1" align="left">info</text>
		<text align="right" font_weight="bold" cond="entite=='FIS'">$(Epreuve.Fichier_transfert_int)..' (Liste n°'..$(Evenement.Code_liste)..')'</text>
		<text align="right" font_weight="bold" cond="entite=='FFS'">$(Epreuve.Fichier_transfert)..' (Liste n°'..$(Evenement.Code_liste)..')'</text>
		<line col_start="1" col_end="0" pen_size="2" pen_color="dkgray" border="bottom"/>
		<!-- <text row="auto" align="left"><pen border="top" />app.GetName()..' Version '..app.GetVersion()..' (FFS - ESF - Agil Informatique) - '..os.date('Edité le %d-%m-%Y à %H:%M:%S')</text> -->
		
		<row h="auto" />
		<matrix col_start="1">
			<row h="auto"/>
			<text col="auto" align="left">app.GetName()..' Version '..app.GetVersion()..' / FFS'</text>
			<image col="0.4cm" adjust="width" align="left">'./res/32x32_ffs.png'</image>
			<text col="auto" align="left" adjust="width">' / ESF'</text>
			<image col="0.4cm" adjust="width" align="left">'./res/32x32_esf.png'</image>
			<text col="auto" align="left">' / Agil Informatique'</text>
			<image col="0.4cm" adjust="width" align="left">'./res/32x32_agil.png'</image>
			<text col="auto" align="left">os.date(' / Edité le %d-%m-%Y à %H:%M:%S')</text>
		</matrix>	
		<text align="right">string.format('Page %d/%s',editor:GetPageCurrent(), editor:GetPageCountLabel())</text>
		<line col_start="1" col_end="0" border="top" />
		<text row="auto" align="left" cond="editor:GetPageCurrent() == 1">$(Evenement.Commentaire)</text>
	</footer>
	
	<!-- Edition Relais-->
	<!-- Liste de départ relais-->
	<report id="Lst_Relais" header="1" first_header="(params.first_header or '1')" >
		<order key="(params.orderby..', Dossard')" />
		<!-- <paper orientation="landscape" /> -->
		<lua>
			if tonumber(params.Officiel) == 1 then
				title = "Liste de départ Officielle \n par équipe"
			elseif	tonumber(params.Officiel) == 0 then
				title = "Liste de départ Officieuse  \n par équipe"
			else
				title = "Liste de départ  \n par équipe "
			end

			_context_border = true;
			
			entite = $(Evenement.Code_entite);
			discipline = $(Epreuve.Code_discipline);
			NbEquipiers = base:GetRecord('Epreuve'):GetInt('Nb_participants');
			app.GetAuiMessage():AddLine("NbEquipiers="..NbEquipiers);
			code_manche = manche or 1
			if discipline == "PATR" then
				EntiteEqu = "Patrouille";
				EntiteRel = "Patrouilleurs";
			else
				EntiteEqu = "Equipe";
				EntiteRel = "Relayeurs";
			end
		</lua>
		
		<label>
			<col w="2,8,4,6cm,1.6cm,3cm,1.5cm,3"/>
			<row h="auto" />
			<text col_start="1" col_end="3"  align="center"><background mode="solid" color="green" />EntiteEqu</text>
			<text col_start="4" col_end="7"  align="center"><background mode="solid" color="yellow" />EntiteRel</text>
			<text col_start="8" col_end="0"  align="center"><background mode="solid" color="green" /></text>
			<row h="auto" />
			<pen border="all" size="1" />
			<text col_start="1" align="center">'Dos'</text>
			<text col_start="2" align="center">'Nom - '..EntiteEqu</text>
			<text col_start="3" align="center">'Sexe'</text>
			<text col_start="4" align="left">'Dos - Identité'</text>
			<text col_start="5" align="center">'Categ.(S.)'</text>
			<text col_start="6" align="center">'Club (CS.)'</text>
			<text col_start="7" align="center">'Pts'</text>
			<text col_start="8" align="center"><background mode="solid" color="green" />'Pts.Equ.'</text>
			<row h="0.4cm"/>
		</label>
		
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<call option="identite" file="./edition/options.xml"/>
			<font size="9" adjust="ellipsize"/>
			<spacing left="10" right="10" top="2" bottom="2" />
			
			<lua>for n=0,tonumber(NbEquipiers)-1 do</lua>
			<row h="0.5cm"/>
			<lua>end</lua>
			<col w="2,8,4,6cm,1.6cm,3cm,1.5cm,3" />
			<text row_start="1" row_end="0" col_start="1" align="right" >$(Dossard)</text>
			<text row_start="1" row_end="0" col_start="2" align="left" >$(Identite)</text> 
			<lua>
				if $(Sexe) == 'F' then 		
					SexeEquipe = 'Féminine';
				elseif $(Sexe) == 'M' then 		
					SexeEquipe = 'Masculine';
				elseif $(Sexe) == 'T' then 		
					SexeEquipe = 'Mixte';
				end
			</lua>
			<text row_start="1" row_end="0" col_start="3" align="center" >SexeEquipe</text>
			<lua>			
				for m=0, NbEquipiers-1 do
					if params.DossardRelais == 'Lettre' then
						LettreDossard = $(Dossard)..'-'..base:GetEquipier($(Code_coureur), m+1, 'Numero');
					else
						LettreDossard = $(Dossard)..'/'..m+1;
					end
			</lua>
			<text row_start='(m+1)' col_start="4" align="left" >LettreDossard..' - '..base:GetEquipier($(Code_coureur), m+1, 'Nom')</text>
			<text row_start='(m+1)' col_start="5" align="center" >base:GetEquipier($(Code_coureur), m+1, 'Categ')..' '..base:GetEquipier($(Code_coureur), m+1, 'Sexe'):Parenthesis()</text>
			<text row_start='(m+1)' col_start="6" align="center" >base:GetEquipier($(Code_coureur), m+1, 'Club')..' '..base:GetEquipier($(Code_coureur), m+1, 'Comite'):Parenthesis()</text>
			<text row_start='(m+1)' col_start="7" align="center" >base:GetEquipier($(Code_coureur), m+1, 'Point')</text>
			<lua>end</lua>  
			<text row_start="1" row_end="0" col_start="8" align="right" >$(Point)</text>
			<row h="0.6cm"/>
		</body>
	</report>	

	<!-- Resultat de relais-->
	<report id="res_Relais" title="Résultats Relais " header="1" first_header="(params.first_header or '1')" modemode_lap="1" >
	<call option="identiteOfficiel" file="./edition/options.xml"/>
<lua>
			if tonumber(params.Officiel) == 1 then
				title = "Résultats Officiels "
			elseif	tonumber(params.Officiel) == 0 then
				title = "Résultats Officieux "
			else
				title = "Résultats Provisoires "
			end
		</lua>
		<column name="Tps_status">chrono.Status(body:GetCellInt('Tps', row))</column>
		<rupture key="Tps_status">
			<before cond="$(Tps_status) ~= 'ok'">
				<font size="14"/>
				<lua>local status = $(Tps_status)</lua>
				<row h="0.5cm"/>
				<text row="auto" col="1" >ranking.Code(status)..' - '..ranking.Label(status)..' ('..body:GetCounterValue('Tps_status', status)..')'</text>
				<row h="0.2cm"/>
			</before>
		</rupture>
		<!-- <paper orientation="landscape" /> -->
		<!-- manque la fonction getNbEquiper() -->
		<lua>
			_context_border = true;
			entite = $(Evenement.Code_entite);
			discipline = $(Epreuve.Code_discipline);
			NbEquipiers = base:GetRecord('Epreuve'):GetInt('Nb_participants');
			app.GetAuiMessage():AddLine("NbEquipiers="..NbEquipiers);
			code_manche = manche or 1
		</lua>
		<order key="Tps, Dossard Desc" />
		
		<label>
			<row h="auto" />
			<row h="auto" />
			<row h="auto" />
			<pen border="all" size="1" />
			<text row_start="1" row_end="1" col="3" align="center" border="none" >'Clt'</text>
			<text row_start="1" row_end="1" col="2" align="center" border="none" >'Dos'</text>
			<text row_start="1" row_end="1" col="10" align="center" border="none" >'Nom - Equipe'</text>
			<text row_start="1" row_end="1" col="4" align="center" border="none" >'S. Relais'</text>
			<col w="1,1,1,1,1,1,1,1,1,1"/>
			
			<text row_start="2" row_end="2" col_start="2" col_end="9" align="center"><background mode="solid" color="yellow" />'Relayeurs'</text>
			<text row_start="3" row_end="3" col_start="2" col_end="4" align="left">'Dos - Code   Identité        (Sexe)'</text>
			<text row_start="3" row_end="3" col_start="5" col_end="7" align="center"><font size="9" adjust="ellipsize"/>'Tps.'</text>
			<text row_start="3" row_end="3" col_start="8" col_end="9" align="center">'Clt. '</text>
			<text row_start="3" row_end="3" col_start="10" col_end="13" align="center">'Tps. Relais'</text>
			<text row_start="1" row_end="1" col="2" align="center" border="none" >'CS.'</text>
			<text row_start="1" row_end="1" col="5" align="right" border="none" >'Tps. Rel.'</text>
			<text row_start="1" row_end="1" col="4" align="right" border="none" >'Ecart. Rel.'</text>
			<row h="0.4cm"/>
		</label>
		
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<call option="identite" file="./edition/options.xml"/>
			<font size="9" adjust="ellipsize"/>
			<spacing left="10" right="10" top="2" bottom="2" />

			<row h="0.6cm"/>
			<lua>for n=0,tonumber(NbEquipiers)-1 do</lua>
			<row h="0.5cm"/>
			<lua>end</lua>
			<col w="3"/>
			<text row_start="1" row_end="1" align="center" border="none" >$(Clt)</text>
			<col w="2"/>
			<text row_start="1" row_end="1" align="right" border="none" >$(Dossard)</text>
			<col w="10"/>
			<text row_start="1" row_end="1" align="left" border="none">$(Identite)</text> 
			<col w="4"/>
				<lua>
					if $(Sexe) == 'F' then 		
						SexeEquipe = 'Féminine';
					elseif $(Sexe) == 'M' then 		
						SexeEquipe = 'Masculine';
					elseif $(Sexe) == 'T' then 		
						SexeEquipe = 'Mixte';
					end
				</lua>
			<text row_start="1" row_end="1" align="center" border="none" >SexeEquipe</text>
			
			
				<col w="1,1,1,1,1,1,1,1,1,1"/>
				<text row_start="1" row_end="1" col_start="4" col_end="14" align="center" border="none" >''</text>
				<lua>					
					for m=0, NbEquipiers-1 do
				</lua>
						<text row_start='(m+2)' col_start="2" col_end="4" align="left" label="('Identité Relayeur '..m+1)">$(Dossard)..'-'..base:GetEquipier($(Code_coureur), m+1, 'Numero')..' - '..base:GetEquipier($(Code_coureur), m+1, 'Nom')..' '..base:GetEquipier($(Code_coureur), m+1, 'Prenom')..' '..base:GetEquipier($(Code_coureur), m+1, 'Sexe'):Parenthesis()</text>
						<text row_start='(m+2)' col_start="5" col_end="7" align="right" label="('Tps Relayeur '..m+1)" >body:GetCell('Tps'..code_manche..'_lap'..m+1, row)</text>
						<text row_start='(m+2)' col_start="8" col_end="9" align="right" label="('Clt Rel'..m+1)" >body:GetCell('Clt'..code_manche..'_lap'..m+1,row)</text>
						<text row_start='(m+2)' col_start="10" col_end="13" align="right" >body:GetCell('Tps_cumul'..code_manche..'_lap'..m+1, row, '[P10]%-1h%-1m%2s.%1f')</text>
				<lua>
					end
				</lua>
			<col w="2"/>
			<!-- <text row_start="1" row_end="1" align="center" label="CS." border="none" >$(Comite)</text> -->
			<text row_start="1" row_end="1" align="center" label="CS." border="none" >$(Club)</text>
			<col w="5"/>
			<text row_start="1" row_end="1" align="right" label="Tps. Equipe" border="none" >$(Tps)</text>
			<col w="4"/>
			<text row_start="1" row_end="1" align="right" label="Ecart. Equipe" border="none" >$(Diff)</text>
			<row h="0.6cm"/>
		</body>
		
		<end cond="tonumber(params.Officiel)==1">
			<lua>sqlBase.FixationTableRanking(body)</lua>
			<call option="signature_dt" file="./edition/options.xml" />
		</end>
	</report>

	<!-- Resultat de Patrouille-->
	<report id="res_Patr" title="Résultats Patrouille " header="1" first_header="(params.first_header or '1')" mode_lap="1" >
		<lua>
			if tonumber(params.Officiel) == 1 then
				title = "Résultats Officiels "
			elseif	tonumber(params.Officiel) == 0 then
				title = "Résultats Officieux "
			else
				title = "Résultats Provisoires "
			end
		</lua>
		<column name="Tps_status">chrono.Status(body:GetCellInt('Tps', row))</column>
		<rupture key="Tps_status">
			<before cond="$(Tps_status) ~= 'ok'">
				<font size="14"/>
				<lua>local status = $(Tps_status)</lua>
				<row h="0.5cm"/>
				<text row="auto" col="1" >ranking.Code(status)..' - '..ranking.Label(status)..' ('..body:GetCounterValue('Tps_status', status)..')'</text>
				<row h="0.2cm"/>
			</before>
		</rupture>
		<!-- <paper orientation="landscape" /> -->
		<!-- manque la fonction getNbEquiper() -->
		<lua>
			_context_border = true;
			entite = $(Evenement.Code_entite);
			discipline = $(Epreuve.Code_discipline);
			NbEquipiers = base:GetRecord('Epreuve'):GetInt('Nb_participants');
			app.GetAuiMessage():AddLine("NbEquipiers="..NbEquipiers);
			code_manche = manche or 1
		</lua>
		<order key="Tps, Dossard Desc" />
		
		<label>
			<row h="auto" />
			<row h="auto" />
			<row h="auto" />
			<pen border="all" size="1" />
			<text row_start="1" row_end="1" col="3" align="center" border="none" >'Clt'</text>
			<text row_start="1" row_end="1" col="2" align="center" border="none" >'Dos'</text>
			<text row_start="1" row_end="1" col="10" align="center" border="none" >'Nom - Patrouille'</text>
			<text row_start="1" row_end="1" col="4" align="center" border="none" >'S. Patrouille'</text>
			<col w="1,1,1,1,1,1,1,1,1,1"/>
			
			<text row_start="2" row_end="2" col_start="2" col_end="10" align="center"><background mode="solid" color="yellow" />'Patrouilleurs'</text>
			<text row_start="3" row_end="3" col_start="2" col_end="4" align="left">'Dos - Code   Identité        (Sexe)'</text>
			<text row_start="3" row_end="3" col_start="5" col_end="9" align="center"><font size="9" adjust="ellipsize"/>'Club'</text>
			<text row_start="3" row_end="3" col_start="10" col_end="11" align="center">'Cs. '</text>
			<text row_start="1" row_end="1" col="2" align="center" border="none" >'CS.'</text>
			<text row_start="1" row_end="1" col="5" align="right" border="none" >'Tps. Pat.'</text>
			<text row_start="1" row_end="1" col="4" align="right" border="none" >'Ecart. Pat.'</text>
			<row h="0.4cm"/>
		</label>
		
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<call option="identite" file="./edition/options.xml"/>
			<font size="9" adjust="ellipsize"/>
			<spacing left="10" right="10" top="2" bottom="2" />

			<row h="0.6cm"/>
			<lua>for n=0,tonumber(NbEquipiers)-1 do</lua>
			<row h="0.5cm"/>
			<lua>end</lua>
			<col w="3"/>
			<text row_start="1" row_end="1" align="center" border="none" >$(Clt)</text>
			<col w="2"/>
			<text row_start="1" row_end="1" align="right" border="none" >$(Dossard)</text>
			<col w="10"/>
			<text row_start="1" row_end="1" align="left" border="none">$(Identite)</text> 
			<col w="4"/>
				<lua>
					if $(Sexe) == 'F' then 		
						SexeEquipe = 'Féminine';
					elseif $(Sexe) == 'M' then 		
						SexeEquipe = 'Masculine';
					elseif $(Sexe) == 'T' then 		
						SexeEquipe = 'Mixte';
					end
				</lua>
			<text row_start="1" row_end="1" align="center" border="none" >SexeEquipe</text>
			
			
				<col w="1,1,1,1,1,1,1,1,1,1"/>
				<text row_start="1" row_end="1" col_start="4" col_end="14" align="center" border="none" >''</text>
				<lua>					
					for m=0, NbEquipiers-1 do
				</lua>
						<text row_start='(m+2)' col_start="2" col_end="4" align="left" label="('Identité Relayeur '..m+1)">$(Dossard)..'-'..base:GetEquipier($(Code_coureur), m+1, 'Numero')..' - '..base:GetEquipier($(Code_coureur), m+1, 'Nom')..' '..base:GetEquipier($(Code_coureur), m+1, 'Prenom')..' '..base:GetEquipier($(Code_coureur), m+1, 'Sexe'):Parenthesis()</text>
						<text row_start='(m+2)' col_start="5" col_end="9" align="right" label="('Tps Relayeur '..m+1)" >base:GetEquipier($(Code_coureur), m+1, 'Club')</text>
						<text row_start='(m+2)' col_start="10" col_end="11" align="right" label="('Clt Rel'..m+1)" >base:GetEquipier($(Code_coureur), m+1, 'Comite')</text>
				<lua>
					end
				</lua>
			<col w="2"/>
			<!-- <text row_start="1" row_end="1" align="center" label="CS." border="none" >$(Comite)</text> -->
			<text row_start="1" row_end="1" align="center" label="CS." border="none" >$(Club)</text>
			<col w="5"/>
			<text row_start="1" row_end="1" align="right" label="Tps. Equipe" border="none" >$(Tps)</text>
			<col w="4"/>
			<text row_start="1" row_end="1" align="right" label="Ecart. Equipe" border="none" >$(Diff)</text>
			<row h="0.6cm"/>
		</body>
		
		<end cond="tonumber(params.Officiel)==1">
			<lua>sqlBase.FixationTableRanking(body)</lua>
			<call option="signature_dt" file="./edition/options.xml" />
		</end>
	</report>
 
	<report id="res_relais_equipier" title="Résultats Relais" >

		<paper orientation="landscape" />
		<lua>nb_lap = base:GetRecord('Epreuve'):GetInt('Nb_participants');</lua>
		<lua>manche = manche or 1</lua>

		<order key="Tps, Dossard Desc" />
	
		<body>
			<call option="couleur_alternee" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
	
			<row value="auto"/>
			<text col="4" align="right" label="Dos.">$(Clt)</text>
			<text col="4" align="right" label="Dos.">$(Dossard)</text>
			<text col="25" align="left" label="Equipe" font_weight="bold" font_size_step="1">$(Nom)</text> 
			<text col="8" align="center" label="Cat.">$(Categ)</text>
			
			<lua>for l=1,nb_lap do</lua>
				<text col="25" cond="group=='label'" label="('Tour'..l)"/>
				<matrix col="25" cond="group=='body'" fit_inside="0" >
					<row h="1"/>
					<font size_step="-1" />
					<text col="16" align="left" font_size_step="-2">base:GetEquipier($(Code_coureur), l, 'Nom')</text>
					<text col="7" align="right">body:GetCell('Tps'..manche..'_lap'..l, row)</text>
					<text col="4" align="right">body:GetCell('Clt'..manche..'_lap'..l,row)</text>
				</matrix> 
			<lua>end</lua>

			<text col="10" cond="group=='label'" label="Temps"/>
			<matrix col="10" cond="group=='body'" fit_inside="0" >
				<row h="1"/>
				<font size_step="1" weight="bold" />
				<text col="7" align="right">body:GetCell('Tps'..manche,row)</text>
				<text col="4" align="right">body:GetCell('Clt'..manche,row)</text>
			</matrix>
				
		</body>
	</report>

	<!-- Edition des X Qualifiés des équipes pour un team sprint Team-sprint-->
	<report id="res_qualif_TeamSprint" title="Team Sprint" first_header="0" >
		<column name="Status_equipe" type="text">' '</column>
		<column name="Type_qualif" type="text">' '</column>
		<lua>
			for i=0, body:GetNbRows()-1 do
				body:SetCell('Type_qualif', i, body:GetCell('Critere', i):sub(1,1));
			end

			for i=0,body:GetNbRows()-1 do 
				if body:GetCell('Critere', i):sub(1,1) == "T" then 
					body:SetCell('Status_equipe', i, "Qualifié");
					ordre_niveau = 1;
					centre = "A";
				else
					ordre_niveau = tonumber(body:GetCell('Clt',i));
					centre = "B";
				end
				reserve = tonumber(body:GetCellInt('Tps1',i)) + tonumber(body:GetCellInt('Tps2',i))
				local cmd = "Update Resultat Set Centre = '"..centre.."', Ordre_niveau = "..ordre_niveau..", reserve = "..reserve.." ";
				cmd =  cmd.."Where Code_evenement = "..body:GetCell('Code_evenement',i).." ";
				cmd =  cmd.."And Code_coureur = '"..body:GetCell('Code_coureur',i).."' ";
				base:Query(cmd);
			end
			
		</lua>		
		<order key="Clt, Tps, Dossard" />		
		<rupture key="Type_qualif">
			<before cond="1">
				<font size="14"/>
				<row value="0.4cm"/>
				<lua>
					local ruptureQualif = 'Suite des classements';
					if $(Type_qualif) == 'A' then ruptureQualif = 'Qualifiés Manche 1';
					elseif $(Type_qualif) == 'B' then ruptureQualif = 'Qualifiés Manche 2';
					elseif $(Type_qualif) == 'T' then ruptureQualif = 'Qualifiés Total des 2 Manches';
					end
				</lua>
				<text row="auto" col="1" >ruptureQualif</text>
			</before>
		</rupture>
		
		<label>
			<pen border="all" size="1" />
			<font size="9" adjust="ellipsize"/>
			<spacing left="10" right="10" top="2" bottom="2" />
			<row h="auto" />
			<text col="6" align="center" >'Clt'</text>
			<text col="4" align="center" >'Dos'</text>
			<text col="15" align="center" >'Nom - Equipe'</text>
			<text col="4" align="center" >'S.'</text>
			<text col="12" align="right" >'Tps | Clt Equipier 1'</text>
			<text col="12" align="right" >'Tps | Clt Equipier 2'</text>
			<text col="12" align="right" >'Tps | Clt Equipe'</text>
			<row h="0.4cm"/>
		</label>
		
		<body>
			<font name="Calibri" size="9" adjust="max" weight="bold" />
			<call option="couleur_alternee" file="./edition/options.xml"/>
			<pen border="none" size="1" />
			
			<row value="auto"/>
			<text col="6" align="center" label="Qualif." font_weight="bold" font_size_step="1"><font color="white" cond="($(Type_qualif) ~= '')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) ~= '')"/>$(Clt)</text>
			<text col="4" align="right" label="Dos">$(Dossard)</text>
			<text col="15" align="left" label="Nom - Prénom" font_weight="bold" font_size_step="1">$(Identite)</text> 
			<text col="4" align="center" label="S." font_size_step="-1">$(Sexe)</text>
			
			<text col="8" align="right" label="Tps.M1">$(Tps1)</text>
			<text col="4" align="right" label="C.M1" font_weight="bold"><font color="white" cond="($(Type_qualif) == 'A')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) == 'A')"/>$(Clt1)</text>
			
			<text col="8" align="right" label="Tps.M2">$(Tps2)</text>
			<text col="4" align="right" label="C.M2" font_weight="bold"><font color="white" cond="($(Type_qualif) == 'B')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) == 'B')"/>$(Clt2)</text>
			
			<text col="8" align="right" label="Total">$(Tps)</text>
			<text col="4" align="right" label="C.T" font_weight="bold"><font color="white" cond="($(Type_qualif) == 'T')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) == 'T')"/>$(Status_equipe)</text>
	
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
		<!-- <end> -->
			<!-- <lua>sqlBase.FixationTableRanking(body)</lua> -->
							<!-- if body:GetCell('Critere', i):sub(1,1) == "T" then  -->
					<!-- body:SetCell('Ordre_niveau', i, body:GetCell('Clt3', i)); -->
				<!-- end -->
		<!-- </end> -->
	</report>
	
	<report id="res_TeamSprint" title="Edition des Qualifiés" first_header="0" >
		<column name="Type_qualif" type="text">' '</column>
		<lua>		
			for i=0, body:GetNbRows()-1 do
				body:SetCell('Type_qualif', i, body:GetCell('Critere', i):sub(1,1));
			end
			body:SetRanking('Clt', 'Centre, Clt3 Asc NULL_OK, Ordre_niveau')
		</lua>
		<order key="Clt, Dossard" />
		<rupture key="Type_qualif">
			<before cond="1">
				<font size="14"/>
				<row value="0.4cm"/>
				<lua>
					local ruptureQualif = 'Suite des classements';
					if $(Type_qualif) == 'A' then ruptureQualif = 'Qualifiés Manche 1';
					elseif $(Type_qualif) == 'B' then ruptureQualif = 'Qualifiés Manche 2';
					elseif $(Type_qualif) == 'T' then ruptureQualif = 'Finale Team-Sprint';
					else
					ruptureQualif = 'Qualification'
					end
				</lua>
				<text row="auto" col="1" >ruptureQualif</text>
			</before>
		</rupture>
		
		<label>
			<font size="9" adjust="ellipsize"/>
			<spacing left="10" right="10" top="2" bottom="2" />
			<row h="auto" />
			<pen border="all" size="1" />
			<text col="6" align="center" >'Clt'</text>
			<text col="4" align="center" >'Dos'</text>
			<text col="17" align="center" >'Nom - Equipe'</text>
			<text col="4" align="center" >'S.'</text>
			<text col="12" align="right" >'Tps | Clt Qualif.1'</text>
			<text col="12" align="right" >'Tps | Clt Qualif.2'</text>
			<text col="12" align="right" >'Tps | Clt Finale'</text>
			<row h="0.4cm"/>
		</label>
		
		<body>
			<font name="Calibri" size="9" adjust="max" weight="bold" />
			<call option="couleur_alternee" file="./edition/options.xml"/>
			<pen border="none" size="1" />
			<row value="auto"/>
			<!-- <text col="6" align="center" label="Qualif." font_weight="bold" font_size_step="1"><font color="white" cond="($(Type_qualif) ~= '')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) ~= '')"/>$(Ordre_niveau)</text> -->
			<text col="6" align="right" label="Clt">$(Clt)</text>
			<text col="4" align="right" label="Dos">$(Dossard)</text>
			<text col="17" align="left" label="Nom - Prénom" font_weight="bold" font_size_step="1">$(Identite)</text> 
			<text col="4" align="center" label="Sexe" font_size_step="-1">$(Sexe)</text>
			<!-- <text col="20" align="center" label="Centre" font_size_step="-1">$(Centre)</text> -->
			<!-- <text col="20" align="center" label="Ordre_niveau" font_size_step="-1">$(Ordre_niveau)</text> -->
			<!-- <text col="20" align="center" label="Clt3" font_size_step="-1">$(Clt3)</text> -->
			<text col="8" align="right" label="Tps.Qualif.1">$(Tps1)</text>
			<text col="4" align="right" label="C.M1" font_weight="bold"><font color="white" cond="($(Type_qualif) == 'T')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) == 'T')"/>$(Clt1)</text>
			
			<text col="8" align="right" label="Tps.Qualif2">$(Tps2)</text>
			<text col="4" align="right" label="C.M2" font_weight="bold"><font color="white" cond="($(Type_qualif) == 'T')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) == 'T')"/>$(Clt2)</text>
			
			<text col="8" align="right" label="Tps.Finale">$(Tps3)</text>
			<text col="4" align="right" label="C.M3" font_weight="bold"><font color="white" cond="($(Type_qualif) == 'T')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) == 'T')"/>$(Clt3)</text>
 
			<!-- <text col="6" align="right" label="Total">$(Tps)</text> -->
			<!-- <text col="4" align="right" label="C.T" font_weight="bold"><font color="white" cond="($(Type_qualif) == 'T')"/><background color="rgb 210 0 1" mode="solid" cond="($(Type_qualif) == 'T')"/>$(Clt)</text> -->
	
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
		<end>
			<lua>sqlBase.FixationTableRanking(body)</lua>
		</end>
	</report>
	
</edition>

