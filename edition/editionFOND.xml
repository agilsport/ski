<?xml version="1.0" encoding="UTF-8"?>

<!--  Menu Editions Activité "FOND" version="7.0"  -->
	<!-- nettoyage du fichier mise en place de la fonction getidentitecoureur  -->
	<!-- Activation de la fenetre filtrage epreuves pour une edition gerer par un .lua => Option filter="before"  -->
	<!-- calcul de la note poursuite 2éme jour  -->
	<!-- si possible de faire fonctionner les cond="discipline:In('POURS')" dans les <menus> ?? dans <marging> et dans les <options>  -->
	 <!-- <paper orientation="landscape" cond="Nb_tps_inter >= 4 "/>  -->
		

<edition>
	<menu>
		<menu title="Listes des Participants " image="./res/32x32_juges.png">
			<menu title="Par Ordre Alphabétique" image="./res/16x16_juges.png" id="part_officiel" />
			<menu title="Par Nation / Alphabétique" image="./res/16x16_juges.png" orderby="Nation" id="participants" />
			<menu title="Par Comité / Alphabétique" image="./res/16x16_juges.png" orderby="Comite" id="participants" />
			<menu title="Par Club / Alphabétique" image="./res/16x16_juges.png" orderby="Club" id="participants" />
			<menu title="Par Ordre de Points" image="./res/16x16_juges.png" id="part_officiel_points" />
			<menu title="Par Epreuve / Alphabétique" image="./res/16x16_juges.png" id="part_epreuve" />
			<menu title="édition des tickets courses " image="./res/16x16_text.png" lua="./edition/TicketsCourse.lua"  />
		</menu>
		
		<menu title="Listes de Départ" image="./res/32x32_bib.png">
			<menu title="Officieuse" image="./res/16x16_official.png" header="1" first_header="0" id="Lst_officielle" officiel="0"/>
			<menu title="Officielle" image="./res/16x16_official.png" id="Lst_officielle" Qrcode="0" officiel="1">
				<menu title="Avec Qrcode Live" image="./res/16x16_bib.png" id="Lst_officielle" Qrcode="1" officiel="1"/>
			</menu>
			<menu title="Trier Par:" image="./res/16x16_official.png">
				<menu title="Nation" image="./res/16x16_bib.png" orderby="Nation" id="Lst_officielle_Filtrer"/>
				<menu title="Comite" image="./res/16x16_bib.png" orderby="Comite" id="Lst_officielle_Filtrer"/>
				<menu title="Club" image="./res/16x16_bib.png" orderby="Club" id="Lst_officielle_Filtrer"/>
			</menu>
			<menu title="Poursuite:" image="./res/16x16_official.png">
				<menu title="Officielle (H. Départ)" image="./res/16x16_official.png" id="Lst_officielle_pours" choix_manche="1" cond="discipline:In('POURS')" officiel="1" header="1" first_header="1"/>
				<menu title="Officieuse (H. Départ)" image="./res/16x16_official.png" id="Lst_officielle_pours" choix_manche="1" cond="discipline:In('POURS')" officiel="0" header="1" first_header="0"/>
				<menu title="Officieuse (Ecart)" image="./res/16x16_official.png" id="Lst_officielle_pours" choix_manche="1" cond="discipline:In('POURS')" officiel="0" header="1" first_header="0"/>
				<menu title="Edition des couloirs" image="./res/16x16_text.png" filter="before" lua="./edition/couloir.lua" cond="discipline:In('POURS')" />
			</menu>
			<menu title="Par Epreuve:" image="./res/16x16_bib.png" >
				<menu title="Nom Prénom" image="./res/16x16_bib.png" id="Lst_epr_speaker" officiel="0" speaker="0" />
				<menu title="Prénom Nom (speaker)" image="./res/16x16_bib.png" id="Lst_epr_speaker" officiel="0" speaker="1" />
				
			</menu>
		</menu>
		
		<menu title="Résultats (Jour 1 et Poursuite) " image="./res/32x32_ranking.png">
			<menu title="Provisoire" image="./res/16x16_ranking.png" id="res_officiel" first_header="0" officiel="0"/>
			<menu title="Officieux" image="./res/16x16_ranking.png" id="res_officiel" first_header="0" officiel="0" />
			<menu title="Officiels" image="./res/16x16_official.png" id="res_officiel" officiel="1" />
			<menu title="Multi épreuve(poursuite)" image="./res/16x16_juges.png"  id="res_epr2"/>
			<menu title="Poursuite:" image="./res/16x16_official.png">
				<menu title="Officiels poursuite" image="./res/16x16_official.png" id="res_off_Pours" officiel="1" />
				<menu title="Officieux poursuite" image="./res/16x16_official.png" id="res_off_Pours" officiel="0" />
			</menu>
			<menu title="Par épreuve / catégories et sexe" image="./res/16x16_ranking.png" id="res_categ" header="1" first_header="0" choix_clt_max="1"/>
			<menu title="Skiathlon" image="./res/16x16_ranking.png" id="res_Skiathlon" header="1" first_header="0" choix_manche="1"/>
			<menu title="Analyse des différences entre chaque temps inter" image="./res/16x16_ranking.png" id="res_DiffInter" header="1" first_header="0" choix_manche="1"/>
		</menu>
	</menu>

	<!-- header standard !-->
	<header>
		<spacing all="0"/>
		<background mode="transparent"/>
		<font name="Calibri" size="14" adjust="max" weight="bold"/>
		<lua>
			entite = $(Evenement.Code_entite)
			discipline = $(Epreuve.Code_discipline)
			type_edition = id:sub(1,4)
			officiel = tonumber(params.officiel)
			Regroupement = $(Epreuve.Code_regroupement)
			if type_edition == 'Lst_' then
				Titre = 'Liste de départ \n '..params.title
			elseif type_edition == 'part' then
				Titre = 'Liste de Participants \n '..params.title
			elseif type_edition == 'res_' then
				Titre = 'Résultats \n '..params.title
			else
				Titre = title
			end
			flagQrCode = 0;
			if params ~= nil and params.Qrcode ~= nil then flagQrCode = params.Qrcode end
		</lua>	
		<text row="auto" col="1" align="center">$(Evenement.Nom)</text>
		<text row="auto" align="center">$(Discipline.Libelle)</text>
		<text row="auto" align="center" cond="params.code_epreuve ~= -1">$(Categorie{$(Epreuve.Code_categorie)}.Libelle)..' - '..$(Sexe{$(Epreuve.Sexe)}.Libelle)</text>
		<text row="auto" align="center" >Titre</text>
		<row h="0.5cm"/>
		<matrix row_start="-3" row_end="0" col_start="10" col_end="0">
			<row h="1.5cm" />
			<col w="1, 1.5cm" />
			<qrcode adjust="best" col_start="2" cond="tonumber(params.Qrcode)==1 and entite=='FFS' ">'https://live.ffs.fr/live_timing/live_cc.php?codex='..$(Epreuve.Fichier_transfert)</qrcode>
			<qrcode adjust="best" col_start="2" cond="tonumber(params.Qrcode)==1 and entite=='FIS' and $(Evenement.Commentaire_live):len() &gt; 0">'live.fis-ski.com/lv-al'..string.sub($(Epreuve.Fichier_transfert),4)..'.htm#/short'</qrcode>
		</matrix>
		<!-- affichage de la ligne d'heure de départ en massstart ou fond pop si pas de first header -->
		<lua>if type_edition == 'lst_' and first_header == '0' and discipline:In('MASS', 'POURS', 'POURS-D', 'FP') and $(Epreuve.Heure_depart):len() &gt; 0 then</lua>
		<call option="Ligne_H_depart" cond="editor:GetPageCurrent() == 1" file="./edition/options.xml"/>
		<lua>end</lua>
		<!-- affichage du Compteur des classés si c'est un resultat (id commence par 'res_' et si le first header n'est pas actif) -->
		<lua>if type_edition == 'res_' and first_header == '0' then</lua>
			<call option="stat_ranking" cond="editor:GetPageCurrent() == 1" file="./edition/options.xml"/>
		<lua>else </lua>
		<row value="0.4cm" />
		<lua>end </lua>
	</header>
		
	<!-- first_header standard !-->
	<first_header >
		<background mode="transparent"/>
		<font name="Calibri" size="9" adjust="best" weight="normal"/>
		<pen border="none" />
		<call option="identiteOfficiel" file="./edition/options.xml"/>
		<lua>type_edition = id:sub(1,4)</lua>
		<lua>entite = $(Evenement.Code_entite)</lua>
		<lua>discipline = $(Epreuve.Code_discipline)</lua>
		<col w="6,5,1, 0.2cm,4,4,1, 0.2cm,4,4,1" />

		<row h="auto" />
		<text col_start="1" col_end="3" align="center" underlined="1" font_size_step="1" font_weight="bold">'JURY DE COMPETITION'</text>
		<text col_start="5" col_end="7" align="center" underlined="1" font_size_step="1" font_weight="bold">'CARACTERISTIQUES DE LA PISTE'</text>
		<text col_start="9" col_end="11" align="center" underlined="1" font_size_step="1" font_weight="bold">'RENSEIGNEMENTS'</text>
		<row h="0.1cm" />

		<row h="auto" />
		<text col_start="1" align="left">'DELEGUE TECHNIQUE '..entite..':'</text>
		<text col_start="2" col_end="3" align="left">GetIdentiteOfficiels('TechnicalDelegate')</text>
		<text col_start="5" align="left" >'Nom du Site :'</text>
		<text col_start="6" align="left" >$(Pistes.Nom_piste)</text>
		<text col_start="9" align="left">'Lieu :'</text>
		<text col_start="10" col_end="0" align="right" >$(Epreuve_Nordique.Lieu)</text>
	
		<row h="auto" />
		<text col_start="1" align="left">'DT Adjoint :'</text>
		<text col_start="2" col_end="3" align="left">GetIdentiteOfficiels('TECHNICALDELEGATEASSISTANT')</text>
		<text col_start="5" align="left" >'Point Haut :'</text>
		<text col_start="6" align="left" >$(Epreuve.Point_haut)</text>
		<text col_start="9" align="left">'Categorie :'</text>
		<text col_start="10" col_end="0" align="right" >$(Categorie{$(Epreuve.Code_categorie)}.Libelle)</text>

		<row h="auto" />
		<text col_start="1" align="left">'DIRECTEUR D\'EPREUVE :'</text>
		<text col_start="2" col_end="3" align="left">GetIdentiteOfficiels('RACEDIRECTOR')</text>
		<text col_start="5" align="left" >'Point Bas :'</text>
		<text col_start="6" align="left" >$(Epreuve.Point_bas)</text>
		<text col_start="9" align="left">'Sexe :'</text>
		<text col_start="10" col_end="0" align="right" >$(Sexe{$(Epreuve.Sexe)}.Libelle)</text>
		
		<row h="auto" />
		<text col_start="1" align="left">'CHEF DE PISTE :'</text>
		<text col_start="2" col_end="3" align="left">GetIdentiteOfficiels('ChiefCompetition')</text>
		<text col_start="5" align="left" >'Montée maxi. :'</text>
		<text col_start="6" align="left" >$(Epreuve.Montee_maxi)</text>
		<text col_start="9" align="left">'Distance épreuve :'</text>
		<text col_start="10" col_end="0" align="right" >$(Epreuve.Distance):Suffix(' Km')</text>
		
		<row h="auto" />
		<text col_start="1" align="left">'COORDONNATEUR- '..entite..':'</text>
		<text col_start="2" align="left">GetIdentiteOfficiels('COORDINATOR')</text>
		<text col_start="5" align="left" >'Montée Totale. :'</text>
		<text col_start="6" align="left" >$(Epreuve.Montee_tot)</text>
		<text col_start="9" align="left">'Style :'</text>
		<lua>
			if $(Epreuve.Style) == 'L' then Style = 'Libre' 
			elseif $(Epreuve.Style) == 'C' then Style = 'Classique' 
			elseif $(Epreuve.Style) == 'C+L' then Style = 'Classique + Libre' 
			elseif $(Epreuve.Style) == 'L+C' then Style = 'Libre + Classique' end 
		</lua>
		<text col_start="10" col_end="0" align="right" >Style</text>
		
		<!-- mise en place de ligne verticale -->
		<line col_start="4" row_start="-5" row_end="0" pen_color="dkgray" border="mid_vert" />
		<line col_start="8" row_start="-5" row_end="0" pen_color="dkgray" border="mid_vert" />
		
		<row h="auto" />
		<lua>
			tClub = base:GetTable('Club')
			base:TableLoad(tClub, "Select * From Club Where Nom_reduit = '"..$(Evenement.Club):EscapeQuote().."'")
		</lua>
		<text col_start="1" col_end="4" align="left">'Club organisateur : '..$(Club.Nom_complet)</text>
		<text col_start="6" col_end="10" align="left" >'Organisateur : '..$(Evenement.Organisateur) </text>
		<!-- retour a la ligne de 0.1cm		 -->
		<row h="0.2cm" />
		<row value="auto" />
		<line col_start="1" col_end="0" pen_color="dkgray" border="top" />
		<row h="auto" />
		<text col_start="1" align="left">'Météo : '..$(Epreuve_Nordique.Meteo)</text>
		<text col_start="2" align="left">'Liste : '..$(Evenement.Code_liste)</text>
		<text col_start="5" col_end="6" align="left" >'Codex Epreuve : '..$(Epreuve.Fichier_transfert) </text>
		<text col_start="8" col_end="9" align="left" >'Coéficient F : '..$(Discipline.Facteur_f)</text>
		<text col_start="10" align="left" cond="params.title=='Officiels'" >'Penalité : '..$(Epreuve.Penalite_appliquee)</text>

		<!-- affichage de la ligne d'heure de départ en massstart ou fond pop -->
		<lua>if type_edition == 'lst_' and discipline:In('MASS','POURS-D', 'FP') and $(Epreuve.Heure_depart):len() &gt; 0 then</lua>
		<call option="Ligne_H_depart" cond="editor:GetPageCurrent() == 1 and $(Epreuve.Heure_depart) ~= nil" file="./edition/options.xml"/>
		<!-- affichage du Compteur des classés si c'est un resultat -->
		<lua>elseif type_edition == 'res_' then</lua>
			<call option="stat_ranking" cond="editor:GetPageCurrent() == 1" file="./edition/options.xml"/>
		<lua>else </lua>
		<row value="0.4cm" />
		<lua>end </lua>

	</first_header>
	
	<!-- footer standard !-->
	<footer>
		<background mode="transparent"/>
		<font name="Calibri" size="8" adjust="best" weight="normal"/>
		<pen border="none" />

		<lua>entite = entite or $(Evenement.Code_entite)</lua>
		<lua>info = $(Epreuve.Date_epreuve,'%2D/%2M/%4Y')..' / '..$(Evenement.Station)..' ('</lua>
		<lua cond="entite=='FIS'">info = info..$(Evenement.Code_nation)..'-'</lua>
		<lua>info = info..$(Evenement.Code_comite).. ') / '..$(Evenement.Organisateur)</lua>
		<text row="auto" col="1" align="left">info</text>
		<text align="right" font_weight="bold" cond="entite=='FIS'">$(Epreuve.Fichier_transfert_int)..' (Liste n°'..$(Evenement.Code_liste)..')'</text>
		<text align="right" font_weight="bold" cond="entite=='FFS'">$(Epreuve.Fichier_transfert)..' (Liste n°'..$(Evenement.Code_liste)..')'</text>
		<line col_start="1" col_end="0" pen_size="2" pen_color="dkgray" border="bottom"/>
		<!-- <text row="auto" align="left"><pen border="top" />app.GetName()..' Version '..app.GetVersion()..' (FFS - ESF - Agil Informatique) - '..os.date('Edité le %d-%m-%Y à %H:%M:%S')</text> -->
		
		<row h="auto" />
		<matrix col_start="1">
			<row h="auto"/>
			<text col="auto" align="left">app.GetName()..' Version '..app.GetVersion()..' / FFS'</text>
			<image col="0.4cm" adjust="width" align="left">'./res/32x32_ffs.png'</image>
			<text col="auto" align="left" adjust="width">' / ESF'</text>
			<image col="0.4cm" adjust="width" align="left">'./res/32x32_esf.png'</image>
			<text col="auto" align="left">' / Agil Informatique'</text>
			<image col="0.4cm" adjust="width" align="left">'./res/32x32_agil.png'</image>
			<text col="auto" align="left">os.date(' / Edité le %d-%m-%Y à %H:%M:%S')</text>
		</matrix>	
		<text align="right">string.format('Page %d/%s',editor:GetPageCurrent(), editor:GetPageCountLabel())</text>
		<line col_start="1" col_end="0" border="top" />
		<text row="auto" align="left" cond="editor:GetPageCurrent() == 1">$(Evenement.Commentaire)</text>
	</footer>	
	
	<!-- Pénalité Nordique -->
	<report id="penalite" title="Calcul de la Pénalité" first_header="0">
		<lua>dofile('./interface/adv.lua');</lua>
		<layers>
			<layer id="ffs">
			</layer>
		</layers>
		
		<end>
			<call option="identiteOfficiel" file="./edition/options.xml"/>
			<lua>entite = base:GetTable("Evenement"):GetCell("Code_entite", 0)</lua>
			<lua>best5 = base:GetTable("best5")</lua>
			
			<!-- Label -->
			<row h="auto"/>
			<font size="10" name ="calibri" weight="bold" adjust="best" />
			<text col="4" align="center">'Clt.'</text>
			<text col="4" align="center">'Dos.'</text>
			<text col="7" align="center">'Code'</text>
			<text col="24" align="center">'Nom - Prénom'</text>
			<text col="4" align="center">'An'</text>
			<text col="4" cond="entite == 'FIS'" align="center">'Nat.'</text>
			<text col="3" align="center">'CR'</text>
			<text col="12" cond="entite == 'FFS'" align="center">'Club'</text>
			<text col="8" align="center">'Pt.Insc.'</text>
			<text col="8" align="center">'3 Notes.'</text>
			<lua>if entite == 'FIS' then col3Notes = 8 else col3Notes = 9 end </lua>
			<text col="8" align="center">'Pt.Compet.'</text>
			<row h="0.2cm"/>
			<!-- 5 Meilleurs à l'arrivée -->
			<text row="auto" col_start="1" col_end="0" align="center" border="1"><font size="12" />'5 MEILLEURS A L\'ARRIVEE'</text>
			<row h="0.2cm"/>
			<lua>for i=0, best5:GetNbRows()-1 do</lua>
				<row h="70px" />
				<text lua="c=1" col_start="(c)" align="right">best5:GetCell('Clt',i)</text>
				<text lua="c=c+1" col_start="(c)" align="right">best5:GetCell('Dossard',i)</text>
				<text lua="c=c+1" col_start="(c)" align="center">best5:GetCell('Code_coureur',i):sub(4)</text>
				<text lua="c=c+1" col_start="(c)" align="left">best5:GetCell('Identite',i)</text>
				<text lua="c=c+1" col_start="(c)" align="center">best5:GetCell('An',i)</text>
				<text lua="c=c+1" col_start="(c)" cond="entite == 'FIS'" align="center">best5:GetCell('Nation',i)</text>
				<text lua="c=c+1" col_start="(c)" align="center">best5:GetCell('Comite',i)</text>
				<text lua="c=c+1" col_start="(c)" cond="entite == 'FFS'" align="center">best5:GetCell('Club',i)</text>
				<text lua="c=c+1" col_start="(c)" align="right">best5:GetCell('Point',i)</text>
				<text lua="c=c+1" col_start="(c)" align="right">best5:GetCell('3Best',i)</text>
				<text lua="c=c+1" col_start="(c)" align="right">best5:GetCell('Pts',i)</text>
			<lua>end</lua>

			<!-- Total -->
			<font size="11" />
			<padding vert="0.1cm" />
			<text row="auto" col_start="1" col_end="(col3Notes-1)" align="right">''</text>
			<text row="auto" col_start="1" col_end="(col3Notes-1)" align="right">'TOTAL'</text>
			<text col_start="(col3Notes)" border="1" align="right">string.format('%-.2f', params.total)</text>
			<row h="0.3cm"/>
			<text row="auto" col_start="1" col_end="(col3Notes-1)" align="right">'/'</text>
			<text col_start="(col3Notes)" border="1" align="right">'3.75'</text>
			<row h="0.3cm"/>
			<text row="auto" col_start="1" col_end="(col3Notes-1)" align="right">'PENALITE CALCULEE'</text>
			<text col_start="(col3Notes)" border="1" align="right">string.format('%-.2f', params.penalite_calculee)</text>
			<row h="0.3cm"/>
			<text row="auto" col_start="1" col_end="(col3Notes-1)" align="right">'PENALITE APPLIQUEE'</text>
			<text col_start="(col3Notes)" border="1" align="right"><background mode="solid" color="yellow" />string.format('%-.2f', params.penalite_appliquee)</text>
			
			<!-- DT Signature -->
			<call option="signature_dt" file="./edition/options.xml" />
		</end>
	</report>
 
<!-- Edition partipants  -->	

	<!-- Liste Par Ordre Alpha -->
	<report id="part_officiel" title="(params.title or '')" header="1" first_header="0" rupture="0">
		<call option="identiteCoureur" file="./edition/options.xml"/>
		
		<order key="Identite Asc" />
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<pen border="none" />
			<row h="auto"/>
			<spacing left="5" right="10" top="2" bottom="2" />
			<text col="4" align="right" label="Dos">$(Dossard) </text>
			<text col="7" align="center" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text>
			<text col="20" align="left" label="Nom - Prénom">GetIdentiteCoureur(officiel)</text> 
			<text col="4" align="center" label="An">$(An)</text>
			<text col="6" align="center" label="Categ">$(Categ)</text>
			<text col="4" align="center" label="S.">$(Sexe)</text>
			<text col="4" align="center" label="Dist.">$(Distance)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="4" align="center" label="CS." >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<text col="6" align="right" label="Points" cond="entite == 'FFS'">$(Point)</text>
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
	</report>

	<!-- Liste Par Ordre points -->
	<report id="part_officiel_points" title="(params.title or '')" header="1" first_header="0" rupture="(params.rupture)">
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<order key="Point Asc ,Dossard Asc, Identite Asc" />
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<pen border="none" />
			<row h="auto"/>
			<spacing left="5" right="10" top="2" bottom="2" />
			<text col="4" align="right" label="Dos">$(Dossard) </text>
			<text col="7" align="center" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text>
			<text col="20" align="left" label="Nom - Prénom">GetIdentiteCoureur(officiel)</text> 
			<text col="4" align="center" label="An">$(An)</text>
			<text col="6" align="center" label="Categ">$(Categ)</text>
			<text col="4" align="center" label="S.">$(Sexe)</text>
			<text col="4" align="center" label="Dist.">$(Distance)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="4" align="center" label="CS." >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<text col="6" align="right" label="Points" cond="entite == 'FFS'">$(Point)</text>
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
	</report>
	
	<!-- Liste Par Nation Comite Club -->
	<report id="participants" title="(params.title)" header="1" first_header="0">
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			page_break = page_break or 1;
			entite = $(Evenement.Code_entite);
			body:SetCounter(params.orderby);
		</lua>
		
		<order key="(params.orderby..', Nom,Prenom')" />
	
		<rupture key="(params.orderby)">
			<before>
				<pagebreak cond="page_break == 1 and row ~= 0" />
				<font name="Calibri" size="16"/>
				<row h="0.5cm" />
				<lua>
					codeClub = $(Club):EscapeQuote()
					tClub = base:GetTable('Club')
					base:TableLoad(tClub, "Select * From Club Where Nom_reduit = '"..codeClub.."'")
					code = body:GetCell(params.orderby, row);
				</lua>
				<text row="auto" col="1" cond="params.orderby == 'Club' and code:len() &gt; 0">$(Club.Nom_complet)..' ('..body:GetCounterValue(params.orderby, code)..')'</text>
				<text row="auto" col="1" cond="params.orderby == 'Nation' and code:len() &gt; 0">code..' - '..$(Nation{code}.Libelle)..' ('..body:GetCounterValue(params.orderby, code)..')'</text>
				<text row="auto" col="1" cond="params.orderby == 'Comite' and code:len() &gt; 0">code..' - '..$(Comite{code}.Nom)..' ('..body:GetCounterValue(params.orderby, code)..')'</text>
				<text row="auto" col="1" cond="code:len() &gt; 0">''</text>
			</before>
		</rupture>
		
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<pen border="none" />
			<row h="auto"/>
			<spacing left="5" right="10" top="2" bottom="2" />
			<text col="4" align="right" label="Dos">$(Dossard) </text>
			<text col="7" align="center" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text>
			<text col="20" align="left" label="Nom - Prénom">GetIdentiteCoureur(officiel)</text> 
			<text col="4" align="center" label="An">$(An)</text>
			<text col="6" align="center" label="Categ">$(Categ)</text>
			<text col="4" align="center" label="S.">$(Sexe)</text>
			<text col="4" align="center" label="Dist.">$(Distance)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="4" align="center" label="CS." >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<text col="6" align="right" label="Points" >$(Point)</text>
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
	</report>
		
	<!-- Liste Par Epreuve -->
	<report id="part_epreuve" title="Liste des participants par Epreuve " header="1" first_header="0">
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			page_break = page_break or 1;
			entite = $(Evenement.Code_entite)
			discipline = $(Epreuve.Code_discipline)
			body:SetCounter('Code_epreuve')
		</lua>
		<order key="Code_epreuve,Identite" />

		<rupture key="Code_epreuve">	
			<before>
				<pagebreak cond="page_break == 1 and row ~= 0" />
				<row h="0.3cm"/>
				<font name="Calibri" size="13"/>
				<lua>
					epr = $(Code_epreuve)
					cat = $(Epreuve{epr}.Code_categorie)
					HeureDepartEpr = $(Epreuve{epr}.Heure_depart)
					NomEpr = $(Categorie{cat}.Libelle)..' / '..$(Epreuve{epr}.Distance)..'Km'
				</lua>
				<text row="auto" col="1">'Epreuve : '..NomEpr..' ('..body:GetCounterValue('Code_epreuve', epr)..') Départ théorique à '..HeureDepartEpr</text>
				<row h="0.2cm"/>
			</before>
		</rupture>

		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<pen border="none" />
			<spacing left="5" right="10" top="2" bottom="2" />
			<row h="auto"/>
			<text col="4" align="right" label="Dos">$(Dossard) </text>
			<text col="7" align="center" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text>
			<text col="20" align="left" label="Nom - Prénom">GetIdentiteCoureur(officiel)</text> 
			<text col="4" align="center" label="An">$(An)</text>
			<text col="6" align="center" label="Categ">$(Categ)</text>
			<text col="4" align="center" label="S.">$(Sexe)</text>
			<text col="4" align="center" label="Dist.">$(Distance)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="4" align="center" label="CS." >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<text col="6" align="right" label="Points" cond="entite == 'FFS'">$(Point)</text>
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
	</report>
	
	<!-- Listes de départ officiels -->
	<report id="Lst_officielle" title="(params.title or '')" header="1" first_header="(params.first_header or '1')" >
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			entite = $(Evenement.Code_entite)
			discipline = $(Epreuve.Code_discipline)
			type_edition = id:sub(1,4)
			officiel = tonumber(params.officiel)
			Regroupement = $(Epreuve.Code_regroupement)
		</lua>	
		<!-- <layers> -->
			<!-- <layer id="bandeauFFS_nordique"> -->
		<!-- </layer> -->
		<!-- </layers> -->
		<!-- <margin left="80" top="320" right="80" bottom="20" cond="Regroupement:In('F','SKI-TOUR')"/> -->
		<!-- <call option="Affiche_bandeauFFS" cond="editor:GetPageCurrent() == 1 and type_edition == 'res_' or type_edition == 'lst_' and officiel == 1 and Regroupement:In('F','SKI-TOUR')" file="./edition/options.xml"/> -->
	
		<order key="Heure_depart1, Dossard, Identite" />
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<pen border="none" />
			<spacing left="5" right="10" top="2" bottom="2" />
			<lua>
				LabelCode = $(Code_coureur):sub(1,3)
			</lua>
			<row h="auto"/>
			<text col="0.5cm" font_size="6" align="center" label="Pb">$(Modif_manuel) </text>
			<text col="4" align="right" label="Dos">$(Dossard) </text>
			<text col="8" align="left" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text>  
			<text col="18" align="left" label="Prénom - Nom" >GetIdentiteCoureur(officiel)</text> 
			<text col="4" align="center" label="An">$(An)</text>
			<text col="6" align="center" label="Categ">$(Categ)</text>
			<text col="4" align="center" label="S.">$(Sexe)</text>
			<text col="4" align="center" label="Dist.">$(Distance)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="4" align="center" label="CS." >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<text col="6" align="right" label="Points" cond="entite == 'FFS'">$(Point)</text>
			<text col="9" align="right" label="H. Départ" cond="discipline:In('FS','KO-QLF','IND')">$(Heure_depart1, "%2hh%2m:%2s")</text>
			<text col="11" align="right" label="H. Départ Pours" cond="discipline:In('POURS')">$(Heure_depart2, "%2hh%2m:%2s")</text>
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
	</report>

	<!-- Listes de départ officiels poursuite-->
	<report id="Lst_officielle_pours" title="(params.title or '')" header="1" first_header="0" >
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			entite = $(Evenement.Code_entite)
			discipline = $(Epreuve.Code_discipline)
			officiel = tonumber(params.officiel)
			rang = 'Rang'..manche
			Hdpt = 'Heure_depart'..manche
			body:OrderBy('Heure_depart'..manche..' Asc' );
			body:AddColumn({ name = 'Diff_heure_depart2', label = 'Diff_heure_depart'..manche, type = sqlType.CHRONO });	
			if body:GetNbRows() > 0 then
				local best_heure_depart2 = body:GetCellInt('Heure_depart'..manche,0);
				for i=0, body:GetNbRows()-1 do
					if body:GetCellInt('Heure_depart'..manche, i, -1) >= best_heure_depart2 then 
						body:SetCell('Diff_heure_depart2', i, body:GetCellInt('Heure_depart'..manche,i) - best_heure_depart2);
					end
					if tonumber(i) == 0 then
						body:SetCell('Diff_heure_depart2', i, 1);
					end
				end
			end
		</lua>
		<order key="('Rang, Heure_depart'..manche..', Dossard, Identite')" />

		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<pen border="none" />
			<spacing left="5" right="10" top="2" bottom="2" />
			<row h="auto"/>
			<!-- <text col="4" align="right" label="Rg.">body:GetCell(rang,row)</text> -->
			<text col="4" align="right" label="Dos">$(Dossard)</text>
			<text col="7" align="center" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text> 
			<text col="18" align="left" label="Prénom - Nom" >GetIdentiteCoureur(officiel)</text> 
			<text col="4" align="center" label="An">$(An)</text>
			<text col="6" align="center" label="Categ">$(Categ)</text>
			<text col="4" align="center" label="S.">$(Sexe)</text>
			<text col="4" align="center" label="Dist.">$(Distance)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="4" align="center" label="CS." >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<!-- <text col="6" align="right" label="Points" cond="entite == 'FFS'">$(Point)</text> -->
			<!-- <text col="9" align="right" label="H. Départ" cond="discipline:In('FS','KO-QLF','IND')">$(Heure_depart1, "%2hh%2m:%2s")</text> -->
			<text col="11" align="right" label="H. Dépt.Pours" cond="officiel==1 " >body:GetCell(Hdpt, row, '%2hh%2m:%2s')</text>
			<text col="11" align="right" label="('Ecart. '..discipline)" cond="officiel==0 ">$(Diff_heure_depart2, '%-1m%2s.%1f')</text>
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
	</report>

	<!-- Liste de départ officielle par Nation Comite Club -->
	<report id="Lst_officielle_Filtrer" title="(params.title or '')" header="1" first_header="0">
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			page_break = page_break or 1;
			discipline = $(Epreuve.Code_discipline);
			entite = $(Evenement.Code_entite);
			body:SetCounter(params.orderby);
		</lua>
		
		<order key="(params.orderby..', Dossard')" />
	
		<rupture key="(params.orderby)">
			<before>
				<pagebreak cond="page_break == 1 and row ~= 0" />
				<font name="Calibri" size="16"/>
				<row h="0.5cm" />
				<lua>
					codeClub = $(Club):EscapeQuote();
					tClub = base:GetTable('Club');
					base:TableLoad(tClub, "Select * From Club Where Nom_reduit = '"..codeClub.."'");
					code = body:GetCell(params.orderby, row);
					if $(Club.Nom_complet) == '' then 
						CodeClub = code;
					else 
						CodeClub = $(Club.Nom_complet);
					end
				</lua>
				<text row="auto" col="1" cond="params.orderby == 'Club' and code:len() &gt; 0">CodeClub..' ('..body:GetCounterValue(params.orderby, code)..')'</text>
				<text row="auto" col="1" cond="params.orderby == 'Nation' and code:len() &gt; 0">code..' - '..$(Nation{code}.Libelle)..' ('..body:GetCounterValue(params.orderby, code)..')'</text>
				<text row="auto" col="1" cond="params.orderby == 'Comite' and code:len() &gt; 0">code..' - '..$(Comite{code}.Nom)..' ('..body:GetCounterValue(params.orderby, code)..')'</text>
				<text row="auto" col="1" cond="code:len() &gt; 0">''</text>
			</before>
		</rupture>
		
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<pen border="none" />
			<spacing left="5" right="10" top="2" bottom="2" />
			<row h="auto"/>
			<text col="0.5cm" font_size="6" align="center" label="Pb">$(Modif_manuel) </text>
			<text col="4" align="right" label="Dos">$(Dossard) </text>
			<text col="7" align="center" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text>
			<text col="20" align="left" label="Nom - Prénom">GetIdentiteCoureur(officiel)</text> 
			<text col="4" align="center" label="An">$(An)</text>
			<text col="6" align="center" label="Categ">$(Categ)</text>
			<text col="4" align="center" label="S.">$(Sexe)</text>
			<text col="4" align="center" label="Dist.">$(Distance)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="4" align="center" label="CS" >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<text col="6" align="right" label="Points" cond="entite == 'FFS'">$(Point)</text>
			<text col="9" align="right" label="H. Départ" cond="discipline:In('FS', 'POURS', 'KO-QLF')">$(Heure_depart1, "%2hh%2m:%2s")</text>
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
	</report>
		
	<!-- Liste de départ officielle par epreuve -->
	<report id="Lst_epr_speaker" title="(params.title or '')" header="1" first_header="0">
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			page_break = page_break or 1;
			entite = $(Evenement.Code_entite);
			discipline = $(Epreuve.Code_discipline);
			body:SetCounter('Code_epreuve');
			officiel = tonumber(params.officiel);
			speaker = tonumber(params.speaker);
		</lua>
		<order key="Code_epreuve, Dossard" />

		<rupture key="Code_epreuve">	
			<before>
				<pagebreak cond="page_break == 1 and row ~= 0" />
				<row h="0.3cm"/>
				<font name="Calibri" size="13"/>
				<lua>
					epr = $(Code_epreuve)
					cat = $(Epreuve{epr}.Code_categorie)
					HeureDepartEpr = $(Epreuve{epr}.Heure_depart)
					NomEpr = $(Categorie{cat}.Libelle)..' / '..$(Epreuve{epr}.Distance)..'Km'
				</lua>
				<text row="auto" col="1">'Epreuve : '..NomEpr..' ('..body:GetCounterValue('Code_epreuve', epr)..') Départ théorique à '..HeureDepartEpr</text>
				<row h="0.2cm"/>
			</before>
		</rupture>
		
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<pen border="none" />
			<spacing left="5" right="10" top="2" bottom="2" />
			<row h="auto"/>
			<text col="4" align="right" label="Dos">$(Dossard) </text>
			<text col="8" align="left" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text> 
			<text col="20" align="left" label="Prénom - Nom" >GetIdentiteCoureur(officiel, speaker)</text>  
			<text col="4" align="center" label="An">$(An)</text>
			<text col="6" align="center" label="Categ">$(Categ)</text>
			<text col="4" align="center" label="S.">$(Sexe)</text>
			<text col="4" align="center" label="Dist.">$(Distance)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="4" align="center" label="CS." >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<text col="6" align="right" label="Points" cond="entite == 'FFS'">$(Point)</text>
			<text col="9" align="right" label="H. Départ" cond="discipline:In('FS','POURS', 'KO-QLF','IND')">$(Heure_depart1, "%2hh%2m:%2s")</text>
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
	</report>

<!-- Résultats  -->
	<!-- Résultats Officiels, Officieux ou Provisoires -->
	<report id="res_officiel" title="(params.title or '')" header="1" first_header="(params.first_header or '1')" >
		<column name="Tps_status">chrono.Status(body:GetCellInt('Tps', row))</column>
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			type_edition = id:sub(1,4);
			body:SetCounter('Tps_status');
			entite = $(Evenement.Code_entite);
			nb_manche = base:GetTable('Epreuve'):GetCellInt('Nombre_de_manche', 0, 1);
			officiel = tonumber(params.officiel);
		</lua>	
		<order key="Tps, Dossard Desc" />
		
		<rupture key="Tps_status">
			<before cond="$(Tps_status) ~= 'ok'">
				<font size="14"/>
				<lua>local status = $(Tps_status)</lua>
				<row h="0.5cm"/>
				<text row="auto" col="1" >ranking.Code(status)..' - '..ranking.Label(status)..' ('..body:GetCounterValue('Tps_status', status)..')'</text>
				<row h="0.2cm"/>
			</before>
		</rupture>

		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font name="calibri" size="9" adjust="ellipsize" />
			<pen border="none" />
			<spacing all="2" />
			<spacing left="7" right="10" top="2" bottom="2" />
			<lua>LabelCode = $(Code_coureur):sub(1,3)</lua>
			<row h="auto"/>  <!-- <font color="Red" cond="$(Sexe) == 'F'and $(Epreuve.sexe) == 'T'"/> -->
			<text col="4" align="center" label="Clt" font_weight="bold" font_size_step="1"> $(Clt)</text>
			<text col="5" align="right" label="Dos">$(Dossard)</text>
			<text col="8" align="right" label="Clt / Cat/ S."><font size_step="-1" cond="group=='body'"/>$(Cltc)..' /'..$(Categ)..' /'..$(Sexe)..' '</text>
			<text col="8" align="left" label="Code"><font size_step="-2" cond="group =='body'"/>$(Code_coureur):sub(4)</text>  
			<text col="18" align="left" label="Prénom - Nom" >GetIdentiteCoureur(officiel)</text> 
			<text col="4" align="center" label="An">$(An)</text>
			<text col="4" align="left" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="3" align="left" label="CS." >$(Comite)</text>
			<text col="12" align="left" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<lua>for m=1,nb_manche do</lua>
				<text col="6" align="right" label="('Tps.M'..m)" cond="nb_manche ~= 1"><font size_step="-1" cond="group == 'body'" />body:GetCell('Tps'..m,row)</text> 
			<lua>end</lua>
			<text col="8" align="right" label="Tps.Tot" font_weight="bold" font_size_step="1">$(Tps)</text> 
			<text col="8" align="right" label="Ecart." font_weight="bold" font_size_step="1">$(Diff)</text> 
			<text col="6" align="right" label="Note" cond="params.title=='Officiels'">$(Note)</text> 
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
		
		<end cond="params.title=='Officiels'">
			<lua>sqlBase.FixationTableRanking(body)</lua>
			<call option="signature_dt" file="./edition/options.xml" />
		</end>
	</report>
		
	<!-- Résultats Officiels, poursuite 2eme jour-->
	<report id="res_off_Pours" title="(params.title or '')" header="1" first_header="(params.first_header or '1')" >
		<column name="Tps_status">chrono.Status(body:GetCellInt('Tps2', row))</column>
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			type_edition = id:sub(1,4)
			officiel = tonumber(params.officiel)
			body:SetCounter('Tps_status')
			entite = $(Evenement.Code_entite)
			nb_manche = base:GetTable('Epreuve'):GetCellInt('Nombre_de_manche', 0, 1)
			nb_inter = tonumber($(Epreuve_Nordique.Nb_temps_inter))
		</lua>
		<order key="Tps2, Dossard Desc" />
		
		<rupture key="Tps_status">
			<before cond="$(Tps_status) ~= 'ok'">
				<font size="14"/>
				<lua>local status = $(Tps_status)</lua>
				<row h="0.5cm"/>
				<text row="auto" col="1" >ranking.Code(status)..' - '..ranking.Label(status)..' ('..body:GetCounterValue('Tps_status', status)..')'</text>
				<row h="0.2cm"/>
			</before>
		</rupture>

		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font name="calibri" size="9" adjust="ellipsize" />
			<pen border="none" />
			<spacing all="2" />
			<spacing left="7" right="10" top="2" bottom="2" />
			<lua>LabelCode = $(Code_coureur):sub(1,3)</lua>
			<row h="auto"/>  <!-- <font color="Red" cond="$(Sexe) == 'F'and $(Epreuve.sexe) == 'T'"/> -->
			<text col="4" align="center" label="Clt" font_weight="bold" font_size_step="1"> $(Clt2)</text>
			<text col="3" align="right" label="Dos">$(Dossard)</text>
			<text col="9" align="right" label="Clt /Cat / S."><font size_step="-1" cond="group=='body'"/>$(Cltc2)..' /'..$(Categ)..' /'..$(Sexe)..' '</text>
			<text col="7" align="center" label="Code"><font size_step="-2" cond="group =='body'"/>$(Code_coureur):sub(4)</text> 
			<text col="18" align="left" label="Prénom - Nom" >GetIdentiteCoureur(officiel)</text>  
			<text col="4" align="center" label="An">$(An)</text>
			<text col="4" align="center" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
			<text col="3" align="center" label="CS." cond="entite == 'FFS'">$(Comite)</text>
			<text col="12" align="center" label="Club" cond="entite == 'FFS'">$(Club)</text>
			<!-- <lua>for m=1,nb_inter do</lua> -->
				<!-- <text col="7" align="right" label="('Tps2_i'..m)" cond="nb_inter ~= 1"><font size_step="-1" cond="group == 'body'" />body:GetCell('Tps2_inter'..m,row)</text>  -->
			<!-- <lua>end</lua> -->
			<text col="8" align="right" label="Tps2" font_weight="bold" font_size_step="1">$(Tps2)</text>
			<text col="8" align="right" label="Ecart." font_weight="bold" font_size_step="1">$(Diff2)</text>
			<text col="6" align="right" label="Note">$(Note)</text> 
			<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
		</body>
		
		<!-- <end cond="params.title=='Officiels'"> -->
			<!-- <lua>sqlBase.FixationTableRanking(body)</lua> -->
			<!-- <call option="signature_dt" file="./edition/options.xml" /> -->
		<!-- </end> -->
	</report>
	
	<!-- Résultats Par Sexe Catégories -->
	<report id="res_categ" title="(params.title or '')"  first_header="0">
		<column name="Tps_status">chrono.Status(body:GetCellInt('Tps', row))</column>
		<column name="Oder_Categ">$(Categorie{$(Categ)}.Ordre)</column>
		<call option="identiteCoureur" file="./edition/options.xml"/>
		<lua>
			page_break = page_break or 1;
			entite = $(Evenement.Code_entite)
			nb_manche = base:GetTable('Epreuve'):GetCellInt('Nombre_de_manche', 0, 1)
		</lua>
		<order key="Code_epreuve, Oder_Categ, Sexe, Tps,  Dossard Desc" />

		<rupture key="Code_epreuve" >
			<before>
				<pagebreak cond="row > 0 and page_break == 1 " />
				<lua>
					epr = $(Code_epreuve)
					cat = $(Epreuve{epr}.Code_categorie)
					NomEpr = $(Categorie{cat}.Libelle)..'  //  '..$(Epreuve{epr}.Distance)..'Km'
				</lua>
				<font size="16"/>
				<row h="0.6cm"/>
				
				<text row="auto" col="1" align="left" ><font color="red" />'Epreuve N°'..$(Code_epreuve)..' -> '..NomEpr</text>
			</before>
		</rupture>

		<rupture key="Sexe" >
			<before>
			<lua>
				SexeEpr = $(Sexe)
				if body:GetCell('Code_epreuve', row) == body:GetCell('Code_epreuve', row-1) then
					if body:GetCell('Sexe', row) ~= body:GetCell('Sexe', row-1) and body:GetCell('Categ', row) == body:GetCell('Categ', row-1) then 
			</lua>
				<pagebreak cond="row ~= 0 and page_break == 1 " />
				<font size="14"/>
				<row h="0.1cm"/>
				<text row="auto" col="1" >$(Categorie{$(Categ)}.Libelle)..' -> '..$(Sexe{SexeEpr}.Libelle)</text>
			<lua>
					end
				end
			</lua>
			</before>
		</rupture>

		<rupture key="Categ" >
			<before>
				<lua>SexeEpr = $(Sexe)</lua>
				<font size="14"/>
				<row h="0.4cm"/>
				<text row="auto" col="1" >$(Categorie{$(Categ)}.Libelle)..' -> '..$(Sexe{SexeEpr}.Libelle)</text>
			</before>
		</rupture>

		<body>
			<lua>clt = body:GetCellInt('Cltc',row,9999)</lua>
			<lua>if clt &lt;= params.clt_max then</lua>
				<call option="color_alternate" file="./edition/options.xml"/>
				<font size="8" adjust="ellipsize"/>
				<spacing left="5" right="10" top="2" bottom="2" />
				<pen border="none" />
				<row h="auto" />
				<text col="5" align="right" label="C.Cat" font_weight="bold" font_size_step="1">$(Cltc)</text>
				<text col="5" align="right" label="C.Tot" font_weight="bold" font_size_step="1">$(Clte)</text>
				<text col="4" align="right" label="Dos">$(Dossard)</text>
				<text col="7" align="center" label="Code"><font size="8" cond="group =='body'"/>$(Code_coureur):sub(4)</text>
				<text col="20" align="left" label="Prénom - Nom" font_weight="bold">GetIdentiteCoureur(officiel)</text> 
				<text col="4" align="center" label="An">$(An)</text>
				<text col="6" align="left" label="Nat" cond="entite == 'FIS'">$(Nation)</text>
				<image col_start="0" adjust="height" align="right" border="0" cond="entite == 'FIS'"><background mode="transparent"/>app.ImageNation($(Nation))</image> 
				<text col="3" align="center" label="CS." >$(Comite)</text>
				<text col="12" align="center" label="Club" cond="entite == 'FFS'">$(Club)</text>
				<lua>for m=1,nb_manche do</lua>
					<lua>if body:GetCellInt('Tps'..m,row) > 0 then cltManche = ' ('..body:GetCell('Cltc'..m,row)..')' else cltManche = '' end</lua>
					<text col="6" align="right" label="('Manche.'..m)" cond="nb_manche ~= 1"><font size_step="-1" cond="group == 'body'" />body:GetCell('Tps'..m,row)..cltManche</text> 
				<lua>end</lua>
				<text col="8" align="right" label="Tps.Tot" font_weight="bold" font_size_step="1">$(Tps)</text> 
				<lua>
					if  body:GetCellInt('Tps',row) == -1 then
						TpscoureurbestCat = 0;
					elseif $(Cltc) == '1' then 
						TpscoureurbestCat = body:GetCellInt('Tps',row);
					end
					
					local Tpscoureur = body:GetCellInt('Tps',row);
					local DiffcoureurbestCat = Tpscoureur - TpscoureurbestCat
						if tonumber(DiffcoureurbestCat) == 0 then 
							DiffcoureurbestCat = '';
						elseif tonumber(DiffcoureurbestCat) > 0 then
							DiffcoureurbestCat = app.TimeToString(tonumber(DiffcoureurbestCat), "[DIFF]%-1h%-1m%2s.%1f");
						else 
							DiffcoureurbestCat = '';
						end
				</lua>
				<text col="8" align="right" label="Ecart." font_weight="bold" font_size_step="1">DiffcoureurbestCat</text>
				<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
			<lua>end</lua>
		</body>
	</report>
	
	<!-- Résultats multi epreuve poursuite -->
	<report id="res_epr2" title="(params.title or '')" first_header="0" >
		<column name="Tps_status">chrono.Status(body:GetCellInt('Tps', row))</column>
		<lua>
			body:SetCounter('Tps_status');
			_context_border = true;
		</lua>
		<order key="Tps, Dossard Desc" />
		
		<rupture key="Tps_status">
			<before cond="$(Tps_status) ~= 'ok'">
				<font size="14"/>
				<lua>local status = $(Tps_status)</lua>
				<row h="0.5cm"/>
				<text row="auto" col="1" >ranking.Code(status)..' - '..ranking.Label(status)..' ('..body:GetCounterValue('Tps_status', status)..')'</text>
				<row h="0.2cm"/>
			</before>
		</rupture>
		
		<label>
			<row h="0.2cm" />
			<row h="auto" />
			<row h="auto" />
			<font weight="bold" />
			<pen border="all" size="1" />
			<text row_start="2"  row_end="0" col="2" align="center">'Clt'</text>
			<text col="12" />
			<background mode="transparent" />
			<text row_start="2" align="left" >'Dossard - Identité'</text> 
			<text row_start="2" align="right" >'Code_coureur'</text>
			<background mode="solid" />
			<text row_start="3" align="left" >'Club - (Comite)'</text> 
			<text col="5" />
			<background mode="transparent" />
			<text row_start="2" align="left" >'Cat.'</text> 
			<text row_start="2" align="right" >'(Cltc.)'</text>
			<background mode="solid" />
			<text row_start="3" align="center" >'Sexe - An.'</text>
			
			<text row_start="2"  row_end="0" col="6" align="center">'Epreuve(s)'</text>
			<text row_start="2"  row_end="0" col="5" align="center">'Tps Epreuve'</text>
			<text row_start="2"  row_end="0" col="6" align="center">'Total'</text>
			<text row_start="2"  row_end="0" col="6" align="center">'Ecart'</text>
			<row h="0.3cm" />
		</label>
		
		<body>
			<call option="color_alternate" file="./edition/options.xml" />
			<font size="9" adjust="ellipsize"/>
			<spacing left="5" right="15" top="2" bottom="2" />
			<pen border="none" />
			<row h="auto"/>
			<row h="auto"/>
			
			<text col="2" row_start="1" row_end="0" align="right" font_weight="bold" font_size_step="1"><background mode="solid" color="green" cond="$(Clt) == '1'" /><font color="white" cond="$(Clt) == '1'"/>$(Clt)</text>
	
			<col w="12"/>
			<text row_start="1">''</text> 
			<background mode="transparent" />
			<text row_start="1" align="left" >$(Dossard)..'-'..$(Identite)</text> 
			<text row_start="1" align="right" >$(Code_coureur):sub(4)</text> 
			<background mode="solid" />
			<text row_start="2" align="left" >$(Club)..' - '..$(Comite{$(Comite)}.Nom):Parenthesis()</text> 
			<col w="5"/>
			<text row_start="1" align="center" >$(Categ)..' - '..$(Cltc):Parenthesis()</text> 
			<text row_start="2" align="center" >$(Sexe)..' - '..$(An)</text> 

		<lua>
			if $(Epreuve.Style) == 'L' then Style = 'Libre' styleprolog = Style stylepours = ''
			elseif $(Epreuve.Style) == 'C' then Style = 'Classique' styleprolog = Style stylepours = ''
			elseif $(Epreuve.Style) == 'C+L' then Style = 'Classique + Libre' styleprolog = 'Classique' stylepours = 'Libre'
			elseif $(Epreuve.Style) == 'L+C' then Style = 'Libre + Classique' styleprolog = 'Libre' stylepours = 'Classique'
			else Style = '-' styleprolog = '-' stylepours = '-'
			end
		</lua>

			<col w="6" />
			<text row_start="1" align="left" >'Epr. 1 :'..styleprolog:Parenthesis()</text> 
			<text row_start="2" align="left" >'Pours. :'..stylepours:Parenthesis()</text> 
	
		
			<col w="5" />
			<text row_start="1" align="center" font_size_step="-2"><background mode="solid" color="yellow" cond="$(Clt1) == '1'" />$(Tps1)..' '..$(Clt1):Parenthesis()</text> 
			<text row_start="2" align="center" font_size_step="-2"><background mode="solid" color="yellow" cond="$(Clt2) == '1'" />$(Tps2)..' '..$(Clt2):Parenthesis()</text> 
	
			<text col="6" row_start="1" row_end="0" align="right" font_weight="bold" font_size_step="1"><background mode="solid" color="green" cond="$(Clt) == '1'" /><font color="white" cond="$(Clt) == '1'"/>$(Tps)</text> 
			
			<text col="6" row_start="1" row_end="0" align="right" font_weight="bold" font_size_step="1">$(Diff)</text> 
			<row h="0.2cm"/>
		</body>
	</report>
	
		<!-- Résultats Skiathlon -->
	<report id="res_Skiathlon" title="(params.title or '')" header="1" first_header="0" >
		<lua>Nb_tps_inter = base:GetTable('Epreuve_Nordique'):GetCellInt('Nb_temps_inter', 0, 1) or 2</lua>
		<!-- <lua>Nb_tps_inter = 2</lua> -->
		<!-- <lua>Nb_tps_inter = base:GetTable('Epreuve_Alpine_Manche'):GetCellInt('Nb_temps_inter', 0, 1)</lua> -->
		<!-- <paper orientation="landscape" cond="Nb_tps_inter >= 4 "/> -->
		
		<!-- création des colonne dans le body -->
		<column name="Diff_I2_I1" type="chrono" />
		<column name="Rank_Diff_I2_I1" type="ranking" />
		<column name="Diff_I3_I2" type="chrono" />
		<column name="Rank_Diff_I3_I2" type="ranking" />
		<column name="('Diff_Tps'..manche..'_I'..Nb_tps_inter)" type="chrono" />
		<column name="('Rank_Diff_Tps'..manche..'_I'..Nb_tps_inter)" type="ranking" />
		<lua>
			ColTpsX = 'Tps'..manche
			ColTpsInterX = 'Tps'..manche..'_inter'..Nb_tps_inter 
			ColdiffTpsinterx = 'Diff_Tps'..manche..'_I'..Nb_tps_inter
			ColRankTpsinterx = 'Rank_Diff_Tps'..manche..'_I'..Nb_tps_inter
			ColrefOrderX = 'Diff_Tps'..manche..'_I'..Nb_tps_inter..', Dossard Desc'
			body:ComputeSubtractTime(ColdiffTpsinterx, ColTpsX, ColTpsInterX)
			body:SetRanking(ColRankTpsinterx, ColrefOrderX)
		</lua>
		<column name="Tps_status">chrono.Status(body:GetCellInt('Tps'..manche, row))</column>
		<lua>body:SetCounter('Tps_status')</lua>
		<lua>
			for m=1,Nb_tps_inter do
				if tonumber(m) >= 2 then
					ColTps2 = 'Tps'..manche..'_inter'..m 
					ColTps1 = 'Tps'..manche..'_inter'..m-1 
					Coldiffinter = 'Diff_I'..m..'_I'..m-1
					colRankdiff = 'Rank_Diff_I'..m..'_I'..m-1
					j = m-1
					ColrefOrder = 'Diff_I'..m..'_I'..j..', Dossard Desc'
					body:ComputeSubtractTime(Coldiffinter, ColTps2, ColTps1)
					body:SetRanking(colRankdiff, ColrefOrder)
				
				end
			end
		</lua>
			
		<lua>
			type_edition = id:sub(1,4)
			body:SetCounter('Tps_status')
			entite = $(Evenement.Code_entite)
			nb_manche = base:GetTable('Epreuve'):GetCellInt('Nombre_de_manche', 0, 1)
		</lua>
		
		<order key="('Tps'..manche..', Dossard Desc')" />
		
		<rupture key="Tps_status">
			<before cond="$(Tps_status) ~= 'ok'">
				<font size="14"/>
				<lua>local status = $(Tps_status)</lua>
				<row h="0.4cm"/>
				<text row="auto" col="1" >ranking.Code(status)..' - '..ranking.Label(status)..' ('..body:GetCounterValue('Tps_status', status)..')'</text>
			</before>
		</rupture>
		


		<body>
			<row h="auto" />
			<row h="auto" />
			<call option="color_alternate" file="./edition/options.xml" />
			<call option="identite" file="./edition/options.xml"/>
			<font name="calibri" size="9" adjust="ellipsize" />
			<spacing all="2" />
			<spacing left="7" right="10" top="2" bottom="2" />
			<col w="1cm"/>
			<text row_start="1" row_end="0" align="center" label="('Clt'..manche)" font_weight="bold" font_size_step="1"><background mode="solid" color="green" cond="group =='body' and (body:GetCell('Clt'..manche ,row)) == '1'" /><font color="white" cond="$(Clt) == '1'"/>body:GetCell('Clt'..manche ,row)</text>
			<col w="1cm"/>
			<text row_start="1" row_end="0" align="center" label="Dos.">$(Dossard)</text>
	
			<col w="5cm"/>
				<text row_start="1">''</text> 
				<background mode="transparent" />
				<text row_start="1" align="left" label="Identité  - Code coureur">$(Identite)</text> 
				<text row_start="1" align="right" >$(Code_coureur):sub(4)</text> 
				<background mode="solid" />
				<text row_start="2" align="left" label="Club - (CS.)">$(Club)..' - '..$(Comite{$(Comite)}.Nom):Parenthesis()</text> 
			<col w="2cm"/>
				<text row_start="1" align="center" label="Categ.(Cltc.)">$(Categ)..' - '..$(Cltc):Parenthesis()</text> 
				<text row_start="2" align="center" label="Sexe - An">$(Sexe)..' - '..$(An)</text> 
			<col w="0.5cm"/>
			<text row_start="1" row_end="0" border="1"></text>
				<matrix col_start="0" row_start="1" row_end="0">
					<row h="auto" />
					<row h="auto" />
					
					<lua>for m=1,Nb_tps_inter do;
							if tonumber(m) == 1 then
					</lua>	
								<col w="2cm" />
								<text row_start="1" row_end="0" col_start="1" align="right" label="Tps Ski(Clt)" ><background mode="solid" color="blue" cond="group =='body' and $(Clt1_inter1) == '1'" /><font color="white" cond="group =='body' and $(Clt1_inter1) == '1'"/>$(Tps1_inter1)..' '..$(Clt1_inter1):Parenthesis()</text>
								
					<lua>	
							else
							j = m-1
					</lua>
						<col w="3cm" />
						<text row_start="1" col_start="(m)" align="right" label="Ski + Materiel" ><background mode="solid" color="blue" cond="group =='body' and (body:GetCell('Clt'..manche..'_inter'..m ,row)) == '1'" /><font color="white" cond="group =='body' and (body:GetCell('Clt'..manche..'_inter'..m ,row)) == '1'"/>body:GetCell('Tps'..manche..'_inter'..m ,row)..' '..body:GetCell('Clt'..manche..'_inter'..m ,row):Parenthesis()</text> 
						<text row_start="2" col_start="(m)" align="left" label="Chagement materiel" ><background mode="solid" color="yellow" cond="group =='body' and (body:GetCell('Rank_Diff_I'..m..'_I'..m-1,row)) == '1'" />body:GetCell('Diff_I'..m..'_I'..m-1,row)..' '..body:GetCell('Rank_Diff_I'..m..'_I'..m-1,row):Parenthesis()</text>
						<lua>end
						end</lua>
						
					<col w="2.5cm" />
						<text row_start="1" col_start="(Nb_tps_inter+1)" align="right" label="('Tps'..manche)" ><background mode="solid" color="green" cond="group =='body' and (body:GetCell('Clt'..manche,row)) == '1'" /><font color="white" cond="group =='body' and (body:GetCell('Clt'..manche,row)) == '1'"/>body:GetCell('Tps'..manche,row)..' '..body:GetCell('Clt'..manche,row):Parenthesis()</text> 
						<text row_start="2" col_start="(Nb_tps_inter+1)" align="left" label="Tps Ski (Clt)" >body:GetCell(ColdiffTpsinterx,row)..'22 '..body:GetCell(ColRankTpsinterx,row):Parenthesis()</text> 
																														  
						<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
						
				</matrix>				
						
		</body>
	</report>
	
		<!-- Résultats diff inter -->
	<report id="res_DiffInter" title="(params.title or '')" header="1" first_header="0" >
		<lua>Nb_tps_inter = base:GetTable('Epreuve_Nordique'):GetCellInt('Nb_temps_inter', 0, 1) or 1</lua>
		<!-- <paper orientation="landscape" cond="Nb_tps_inter >= 4 "/> -->
		<!-- création des colonne dans le body -->
		<column name="Diff_I2_I1" type="chrono" />
		<column name="Rank_Diff_I2_I1" type="ranking" />
		<column name="Diff_I3_I2" type="chrono" />
		<column name="Rank_Diff_I3_I2" type="ranking" />
		<column name="('Diff_Tps'..manche..'_I'..tonumber(Nb_tps_inter))" type="chrono" />
		<column name="('Rank_Diff_Tps'..manche..'_I'..tonumber(Nb_tps_inter))" type="ranking" />
		<lua>
			ColTpsX = 'Tps'..manche
			ColTpsInterX = 'Tps'..manche..'_inter'..Nb_tps_inter 
			ColdiffTpsinterx = 'Diff_Tps'..manche..'_I'..Nb_tps_inter
			ColRankTpsinterx = 'Rank_Diff_Tps'..manche..'_I'..Nb_tps_inter
			ColrefOrderX = 'Diff_Tps'..manche..'_I'..Nb_tps_inter..', Dossard Desc'
			body:ComputeSubtractTime(ColdiffTpsinterx, ColTpsX, ColTpsInterX)
			body:SetRanking(ColRankTpsinterx, ColrefOrderX)
		</lua>
		<column name="Tps_status">chrono.Status(body:GetCellInt('Tps'..manche, row))</column>
		<lua>
			body:SetCounter('Tps_status')
			for m=1,Nb_tps_inter do
				if tonumber(m) >= 2 then
					ColTps2 = 'Tps'..manche..'_inter'..m 
					ColTps1 = 'Tps'..manche..'_inter'..m-1 
					Coldiffinter = 'Diff_I'..m..'_I'..m-1
					colRankdiff = 'Rank_Diff_I'..m..'_I'..m-1
					j = m-1
					ColrefOrder = 'Diff_I'..m..'_I'..j..', Dossard Desc'
					body:ComputeSubtractTime(Coldiffinter, ColTps2, ColTps1)
					body:SetRanking(colRankdiff, ColrefOrder)
				
				end
			end
		</lua>
			
		<lua>
			type_edition = id:sub(1,4)
			body:SetCounter('Tps_status')
			entite = $(Evenement.Code_entite)
			nb_manche = base:GetTable('Epreuve'):GetCellInt('Nombre_de_manche', 0, 1)
		</lua>
		
		<order key="('Tps'..manche..', Dossard Desc')" />
		
		<rupture key="Tps_status">
			<before cond="$(Tps_status) ~= 'ok'">
				<font size="14"/>
				<lua>local status = $(Tps_status)</lua>
				<row h="0.4cm"/>
				<text row="auto" col="1" >ranking.Code(status)..' - '..ranking.Label(status)..' ('..body:GetCounterValue('Tps_status', status)..')'</text>
			</before>
		</rupture>
		


		<body>
			<row h="auto" />
			<row h="auto" />
			<call option="color_alternate" file="./edition/options.xml" />
			<call option="identite" file="./edition/options.xml"/>
			<font name="calibri" size="9" adjust="ellipsize" />
			<spacing all="2" />
			<spacing left="7" right="10" top="2" bottom="2" />
			<col w="1cm"/>
			<text row_start="1" row_end="0" align="center" label="('Clt'..manche)" font_weight="bold" font_size_step="1"><background mode="solid" color="green" cond="(body:GetCell('Clt'..manche ,row)) == '1'" /><font color="white" cond="$(Clt) == '1'"/>body:GetCell('Clt'..manche ,row)</text>
			<col w="1cm"/>
			<text row_start="1" row_end="0" align="center" label="Dos.">$(Dossard)</text>
	
			<col w="5cm"/>
				<text row_start="1">''</text> 
				<background mode="transparent" />
				<text row_start="1" align="left" label="Identité  - Code coureur">$(Identite)</text> 
				<text row_start="1" align="right" >$(Code_coureur):sub(4)</text> 
				<background mode="solid" />
				<text row_start="2" align="left" label="Club - (CS.)">$(Club)..' - '..$(Comite{$(Comite)}.Nom):Parenthesis()</text> 
			<col w="2cm"/>
				<text row_start="1" align="center" label="Categ.(Cltc.)">$(Categ)..' - '..$(Cltc):Parenthesis()</text> 
				<text row_start="2" align="center" label="Sexe - An">$(Sexe)..' - '..$(An)</text> 
			<col w="0.5cm"/>
			<text row_start="1" row_end="0" border="1"></text>
				<matrix col_start="0" row_start="1" row_end="0">
					<row h="auto" />
					<row h="auto" />
					<lua>
						for m=1,Nb_tps_inter do;
							if tonumber(m) == 1 then
						</lua>	
								<col w="2cm" />
								<text row_start="1" row_end="0" col_start="1" align="right" label="('Inter'..m..'(Clt)')" ><background mode="solid" color="blue" cond="$(Clt1_inter1) == '1'" /><font color="white" cond="$(Clt1_inter1) == '1'"/>$(Tps1_inter1)..' '..$(Clt1_inter1):Parenthesis()</text>	
						<lua>	
							else
								j = m-1
						</lua>
								<col w="2.5cm" />
								<text row_start="1" col_start="(m)" align="right" label="('Inter'..m)" ><background mode="solid" color="blue" cond="group =='body' and (body:GetCell('Clt'..manche..'_inter'..m ,row)) == '1'" /><font color="white" cond="(body:GetCell('Clt'..manche..'_inter'..m ,row)) == '1'"/>body:GetCell('Tps'..manche..'_inter'..m ,row)..' '..body:GetCell('Clt'..manche..'_inter'..m ,row):Parenthesis()</text> 
								<text row_start="2" col_start="(m)" align="left" label="('Diff.I'..m..'/ I'..j..'(Clt)')" ><background mode="solid" color="yellow" cond="group =='body' and (body:GetCell('Rank_Diff_I'..m..'_I'..m-1,row)) == '1'" />body:GetCell('Diff_I'..m..'_I'..m-1,row)..' '..body:GetCell('Rank_Diff_I'..m..'_I'..m-1,row):Parenthesis()</text>
						<lua>end
						end
					</lua>
						
					<col w="2.5cm" />
						<text row_start="1" col_start="(Nb_tps_inter+1)" align="right" label="('Tps'..manche)" ><background mode="solid" color="green" cond="(body:GetCell('Clt'..manche,row)) == '1'" /><font color="white" cond="(body:GetCell('Clt'..manche,row)) == '1'"/>body:GetCell('Tps'..manche,row)..' '..body:GetCell('Clt'..manche,row):Parenthesis()</text> 
						<text row_start="2" col_start="(Nb_tps_inter+1)" align="left" label="(ColdiffTpsinterx..'(Clt)')" ><background mode="solid" color="yellow" cond="(body:GetCell(ColRankTpsinterx,row)) == '1'" />body:GetCell(ColdiffTpsinterx,row)..' '..body:GetCell(ColRankTpsinterx,row):Parenthesis()</text> 
						
						<line col_start="1" col_end="0" pen_size="4" border="bottom" cond="not _context_border"/>
						
				</matrix>				
						
		</body>

	</report>	
	
</edition>

